---
phase: 07-polish-terminal-compat
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/shell/keybinding.go
  - internal/shell/keybinding_test.go
  - internal/shell/zsh.go
  - internal/shell/bash.go
  - internal/shell/fish.go
  - internal/shell/powershell.go
  - cmd/wf/init_shell.go
autonomous: true
requirements: [TERM-01, TERM-02]

must_haves:
  truths:
    - "User on Warp terminal runs wf init zsh and gets Ctrl+O keybinding automatically"
    - "User sees stderr message explaining Warp detection and key assignment"
    - "User can run wf init zsh --key ctrl+o to set custom keybinding"
    - "User attempting --key ctrl+c gets an error explaining the danger"
    - "Generated shell script includes comment block explaining the bound key"
    - "All four shells (zsh, bash, fish, powershell) support custom keybinding"
  artifacts:
    - path: "internal/shell/keybinding.go"
      provides: "Keybinding type with Parse, Validate, ForZsh, ForBash, ForFish, ForPowerShell"
      exports: ["Keybinding", "ParseKey", "DefaultKey", "WarpDefaultKey"]
    - path: "internal/shell/keybinding_test.go"
      provides: "Tests for key parsing, validation, and shell-specific format conversion"
      min_lines: 60
    - path: "cmd/wf/init_shell.go"
      provides: "Updated init command with --key flag and Warp detection"
  key_links:
    - from: "cmd/wf/init_shell.go"
      to: "internal/shell/keybinding.go"
      via: "ParseKey + Validate + ForZsh/ForBash/ForFish/ForPowerShell"
      pattern: "shell\\.ParseKey"
    - from: "cmd/wf/init_shell.go"
      to: "$TERM_PROGRAM"
      via: "os.Getenv for Warp detection"
      pattern: "WarpTerminal"
    - from: "internal/shell/zsh.go"
      to: "text/template"
      via: "ZshTemplate with {{.Key}} placeholder"
      pattern: "template\\.Must"
---

<objective>
Create keybinding system for custom key configuration and Warp terminal auto-detection, converting shell scripts from const strings to templates.

Purpose: Users on Warp terminal get a working keybinding automatically (TERM-01), and all users can customize via `--key` flag (TERM-02). Resolves the known Warp Ctrl+G conflict.

Output: `internal/shell/keybinding.go` with Keybinding type, shell script templates, updated `wf init` command.
</objective>

<execution_context>
@/Users/fredriklanga/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/fredriklanga/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-terminal-compat/07-CONTEXT.md
@.planning/phases/07-polish-terminal-compat/07-RESEARCH.md
</context>

<interfaces>
<!-- Current shell scripts that will be modified. -->

From internal/shell/zsh.go (current — const string with hardcoded ^G):
```go
const ZshScript = `# wf shell integration for zsh
...
bindkey -M emacs '^G' _wf_picker
bindkey -M viins '^G' _wf_picker
bindkey -M vicmd '^G' _wf_picker
...`
```

From cmd/wf/init_shell.go (current — no flags, simple switch):
```go
var initCmd = &cobra.Command{
    Use:       "init [shell]",
    Args:      cobra.ExactArgs(1),
    ValidArgs: []string{"zsh", "bash", "fish", "powershell"},
    RunE: func(cmd *cobra.Command, args []string) error {
        var script string
        switch args[0] {
        case "zsh": script = shell.ZshScript
        ...
        }
        _, err := os.Stdout.WriteString(script)
        return err
    },
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create Keybinding type with parsing, validation, and shell format conversion</name>
  <files>internal/shell/keybinding.go, internal/shell/keybinding_test.go</files>
  <action>
**Create `internal/shell/keybinding.go`** with:

1. **`Keybinding` struct** — `Modifier string` ("ctrl" or "alt"), `Letter string` (single lowercase letter a-z)

2. **Constants:**
   - `DefaultKey` — `Keybinding{Modifier: "ctrl", Letter: "g"}` (current default)
   - `WarpDefaultKey` — `Keybinding{Modifier: "ctrl", Letter: "o"}` (Warp fallback)

3. **`ParseKey(input string) (Keybinding, error)`** — parses "ctrl+g", "alt+f", "Ctrl+G" (case-insensitive). Returns error for invalid format. Only accepts `modifier+letter` where modifier is ctrl/alt and letter is a single a-z character.

4. **`(k Keybinding) Validate() error`** — blocks dangerous combinations. Blocked keys with reasons:
   - ctrl+c → "SIGINT (interrupt process)"
   - ctrl+d → "EOF (close shell)"  
   - ctrl+z → "SIGTSTP (suspend process)"
   - ctrl+s → "XOFF (freeze terminal output)"
   - ctrl+q → "XON (resume terminal output)"
   - ctrl+\\ → "SIGQUIT (core dump)"
   - ctrl+[ → "Escape key equivalent"
   Return descriptive error like: `key "ctrl+c" conflicts with essential terminal function: SIGINT (interrupt process)`

5. **`(k Keybinding) String() string`** — returns "Ctrl+G" format for display

6. **Shell-specific format methods:**
   - `ForZsh() string` — `\C-g` for ctrl, `\eg` for alt
   - `ForBash() string` — `\C-g` for ctrl, `\eg` for alt (same as zsh)
   - `ForFish() string` — `\cg` for ctrl (lowercase, no dash!), `\eg` for alt
   - `ForPowerShell() string` — `Ctrl+G` for ctrl, `Alt+G` for alt (uppercase letter)

7. **`TemplateData` struct** — `Key string`, `Comment string` (used by shell templates)

8. **`DetectWarp() bool`** — returns `os.Getenv("TERM_PROGRAM") == "WarpTerminal"`

**Create `internal/shell/keybinding_test.go`** with tests:
- ParseKey: "ctrl+g" → valid, "Ctrl+G" → valid (case insensitive), "alt+f" → valid
- ParseKey: "ctrl+1" → error (not a letter), "shift+g" → error (unsupported modifier), "g" → error (no modifier), "ctrl+gg" → error (not single letter)
- Validate: ctrl+c → error, ctrl+d → error, ctrl+z → error, ctrl+g → valid, ctrl+o → valid
- ForZsh: ctrl+g → `\C-g`, alt+f → `\ef`
- ForFish: ctrl+g → `\cg` (note: no dash, lowercase c)
- ForPowerShell: ctrl+g → `Ctrl+G`
  </action>
  <verify>
```bash
go build ./internal/shell/... && go test ./internal/shell/... -v -count=1
```
  </verify>
  <done>
  - Keybinding type parses, validates, and converts key combos
  - All dangerous keys blocked with descriptive errors
  - All four shell formats produce correct escape sequences
  - Tests pass for parsing, validation, and format conversion
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert shell scripts to templates and update wf init with --key flag and Warp detection</name>
  <files>internal/shell/zsh.go, internal/shell/bash.go, internal/shell/fish.go, internal/shell/powershell.go, cmd/wf/init_shell.go</files>
  <action>
**Modify each shell script file** (zsh.go, bash.go, fish.go, powershell.go):

Replace the `const XxxScript` with a `var XxxTemplate = template.Must(template.New("xxx").Parse(...))` where:
- All hardcoded keybinding references (e.g., `'^G'`, `\cg`, `'Ctrl+g'`) are replaced with `{{.Key}}`
- Add `{{.Comment}}` at the top of the script (after the usage comment, before the function definition)
- Keep the `_wf_precmd` / `_wf_postexec` hooks unchanged (they don't involve keybinding)
- Import `"text/template"` in each file

**Specific per-shell changes:**

**zsh.go:** Replace `const ZshScript` with `var ZshTemplate`. Change `'^G'` → `'{{.Key}}'` in all three bindkey lines. Add `{{.Comment}}` line.

**bash.go:** Replace `const BashScript` with `var BashTemplate`. Change `'"\C-g"'` → `'"{{.Key}}"'` in both bind lines. Add `{{.Comment}}` line.

**fish.go:** Replace `const FishScript` with `var FishTemplate`. Change `\cg` → `{{.Key}}` in both bind lines. Add `{{.Comment}}` line.

**powershell.go:** Replace `const PowerShellScript` with `var PowerShellTemplate`. Change `'Ctrl+g'` → `'{{.Key}}'` in Set-PSReadLineKeyHandler. Add `{{.Comment}}` line.

**Modify `cmd/wf/init_shell.go`:**

1. Add `--key` string flag to `initCmd` (default empty string). Register in an `init()` function.

2. Update `RunE` to:
   a. Determine the keybinding:
      - If `--key` is set: parse with `shell.ParseKey()`, validate with `.Validate()`, use result
      - Else if `shell.DetectWarp()`: use `shell.WarpDefaultKey`, print to stderr: `fmt.Fprintf(os.Stderr, "wf: Warp terminal detected — binding to %s instead of %s\n", shell.WarpDefaultKey, shell.DefaultKey)`
      - Else: use `shell.DefaultKey`
   
   b. Build template data:
      ```go
      keyStr := key.ForXxx() // shell-specific format
      comment := fmt.Sprintf("# Keybinding: %s\n# Change with: wf init %s --key ctrl+<letter>", key.String(), shellName)
      data := shell.TemplateData{Key: keyStr, Comment: comment}
      ```
   
   c. Execute the template into a `bytes.Buffer`, write to stdout.

3. Update Long description and Example to mention `--key` flag.

**Important:** The existing `cli_test.go` in `cmd/wf/` may reference `shell.ZshScript` etc. If any test references these constants, update to use template rendering instead (execute template with DefaultKey).
  </action>
  <verify>
```bash
go build ./... && go test ./internal/shell/... -v -count=1 && go test ./cmd/wf/... -v -count=1 -run TestCLI
```

Manual spot check:
```bash
go run ./cmd/wf init zsh 2>/dev/null | head -10
# Should show template rendered with Ctrl+G default

go run ./cmd/wf init zsh --key ctrl+o 2>/dev/null | head -10
# Should show Ctrl+O keybinding

go run ./cmd/wf init zsh --key ctrl+c 2>&1
# Should show error about dangerous key
```
  </verify>
  <done>
  - All four shell scripts are templates with {{.Key}} and {{.Comment}} placeholders
  - wf init --key ctrl+o produces shell script with Ctrl+O binding
  - wf init on Warp terminal auto-selects Ctrl+O and prints stderr message
  - wf init --key ctrl+c returns descriptive error
  - Generated scripts include comment block explaining bound key and how to change
  - All existing tests pass (no regressions from const→template change)
  </done>
</task>

</tasks>

<verification>
```bash
# Full build
go build ./...

# Shell package tests
go test ./internal/shell/... -v -count=1

# CLI tests (if any reference shell scripts)
go test ./cmd/wf/... -v -count=1

# Spot check outputs
go run ./cmd/wf init zsh 2>/dev/null | grep -c "bindkey"
# Should output 3 (three bindkey lines)

go run ./cmd/wf init bash 2>/dev/null | grep -c "bind"
# Should output 2

go run ./cmd/wf init fish 2>/dev/null | grep -c "bind"
# Should output 2
```
</verification>

<success_criteria>
- Keybinding parsing, validation, and format conversion work for all four shells
- Shell scripts are templates with customizable keybinding
- wf init detects Warp and auto-selects Ctrl+O with stderr message
- wf init --key flag lets any user customize their keybinding
- Dangerous keys (ctrl+c/d/z/s/q) are blocked with descriptive errors
- All tests pass, project compiles
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-terminal-compat/07-02-SUMMARY.md`
</output>
