---
phase: 01-foundation-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - cmd/wf/main.go
  - cmd/wf/root.go
  - internal/config/config.go
  - internal/store/workflow.go
  - internal/store/store.go
  - internal/store/yaml.go
  - internal/store/yaml_test.go
autonomous: true

must_haves:
  truths:
    - "Workflow struct correctly represents a workflow with name, command, description, tags, and args"
    - "YAML store can save a workflow to disk and read it back with byte-level fidelity"
    - "Multiline commands survive YAML round-trip using block scalars"
    - "YAML Norway Problem values (no, yes, on, off, true, false) in command strings are not corrupted"
    - "Store resolves workflow path under XDG config directory (~/.config/wf/workflows/)"
  artifacts:
    - path: "go.mod"
      provides: "Go module definition with pinned dependencies"
      contains: "github.com/spf13/cobra"
    - path: "cmd/wf/main.go"
      provides: "Binary entry point"
      contains: "func main()"
    - path: "internal/store/workflow.go"
      provides: "Workflow domain model"
      contains: "type Workflow struct"
    - path: "internal/store/store.go"
      provides: "Store interface for workflow CRUD"
      contains: "type Store interface"
    - path: "internal/store/yaml.go"
      provides: "YAML file-based Store implementation"
      contains: "func (s *YAMLStore)"
    - path: "internal/store/yaml_test.go"
      provides: "Round-trip tests for YAML storage"
      min_lines: 80
  key_links:
    - from: "internal/store/yaml.go"
      to: "internal/store/workflow.go"
      via: "marshals/unmarshals Workflow structs"
      pattern: "Workflow"
    - from: "internal/store/yaml.go"
      to: "internal/config/config.go"
      via: "resolves base path for workflow storage"
      pattern: "config\\.WorkflowsDir|BasePath"
    - from: "cmd/wf/main.go"
      to: "cmd/wf/root.go"
      via: "executes root Cobra command"
      pattern: "rootCmd\\.Execute|root\\.Execute"
---

<objective>
Scaffold the Go project and build the core data layer: Workflow domain model, YAML file store with Norway Problem protection, and XDG-compliant config resolution.

Purpose: Everything in wf depends on the data layer. The Workflow model and YAML store are the foundation that CLI commands, template engine, search, and TUI all build on. Getting YAML serialization right (especially the Norway Problem) prevents silent data corruption.

Output: Working Go project with Cobra CLI skeleton, Workflow struct, YAML store with full CRUD operations, config package for XDG path resolution, and round-trip tests proving data integrity.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-layer/01-CONTEXT.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go project scaffold with Cobra CLI and XDG config</name>
  <files>
    go.mod
    cmd/wf/main.go
    cmd/wf/root.go
    internal/config/config.go
  </files>
  <action>
    Initialize the Go module and create the project skeleton:

    1. Run `go mod init github.com/fredriklanga/wf` (or appropriate module name)
    2. Install core dependencies:
       - `github.com/spf13/cobra` v1.10.2 (CLI framework)
       - `github.com/goccy/go-yaml` (YAML — NOT gopkg.in/yaml.v3, it's unmaintained since April 2025)
       - `github.com/adrg/xdg` (XDG directory resolution)
       - `github.com/stretchr/testify` (test assertions)

    3. Create `cmd/wf/main.go`:
       - Entry point calling `rootCmd.Execute()`
       - Keep it minimal — just runs the root command

    4. Create `cmd/wf/root.go`:
       - Cobra root command `wf` with short/long description
       - Set `Use: "wf"`, `Short: "Terminal workflow manager"`
       - Add placeholder `version` flag
       - Subcommands (add, edit, rm) will be registered in Plan 03

    5. Create `internal/config/config.go`:
       - Function `WorkflowsDir() string` that returns `~/.config/wf/workflows/` via `adrg/xdg`
       - Use `xdg.ConfigHome` + `/wf/workflows/` (NOT `os.UserConfigDir()` — returns wrong path on macOS, see Pitfall 7)
       - Function `EnsureDir()` that creates the workflows directory if it doesn't exist (`os.MkdirAll` with 0755)
       - No config file loading yet — just path resolution

    6. Verify: `go build ./cmd/wf/` compiles, `go run ./cmd/wf/ --help` shows help text
  </action>
  <verify>
    `go build ./cmd/wf/` succeeds with zero errors.
    `go run ./cmd/wf/ --help` prints usage info with "Terminal workflow manager" in output.
    `go vet ./...` passes.
  </verify>
  <done>
    Go project compiles. Cobra root command responds to `--help`. Config package resolves XDG workflows directory path correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workflow domain model + YAML store with round-trip tests</name>
  <files>
    internal/store/workflow.go
    internal/store/store.go
    internal/store/yaml.go
    internal/store/yaml_test.go
  </files>
  <action>
    Build the Workflow model and YAML file store:

    1. Create `internal/store/workflow.go`:
       - `type Workflow struct` with fields:
         - `Name string` (yaml:"name") — human-readable name, also used to derive filename
         - `Command string` (yaml:"command") — the command template, may contain `{{params}}`
         - `Description string` (yaml:"description") — what this workflow does
         - `Tags []string` (yaml:"tags") — flat list of string tags
         - `Args []Arg` (yaml:"args,omitempty") — detailed parameter definitions
       - `type Arg struct` with fields:
         - `Name string` (yaml:"name")
         - `Default string` (yaml:"default,omitempty")
         - `Description string` (yaml:"description,omitempty")
       - Helper method `Workflow.Filename() string` — slugify name to filesystem-safe name (lowercase, spaces to hyphens, strip special chars) + `.yaml` extension
       - All string fields must be typed as `string` (not `interface{}`) to prevent YAML boolean coercion — this is the Norway Problem fix

    2. Create `internal/store/store.go`:
       - `type Store interface` with methods:
         - `List() ([]Workflow, error)` — list all workflows
         - `Get(name string) (*Workflow, error)` — get by name
         - `Save(w *Workflow) error` — create or update
         - `Delete(name string) error` — remove workflow file
       - This interface allows future alternative implementations (e.g., in-memory for testing)

    3. Create `internal/store/yaml.go`:
       - `type YAMLStore struct` implementing Store interface
       - Constructor `NewYAMLStore(basePath string) *YAMLStore`
       - `Save()`: Marshal workflow to YAML, write to `basePath/workflow.Filename()`
         - Use `goccy/go-yaml` marshaller
         - For multiline commands (containing `\n`), use YAML block scalar style (`|`)
         - CRITICAL: Handle Norway Problem — ensure command strings with values like "no", "yes", "on", "off" are preserved as strings. With goccy/go-yaml, typed string fields handle this correctly during unmarshal. For marshal, verify output uses quoting for ambiguous values. Add custom MarshalYAML if needed.
       - `Get()`: Read YAML file, unmarshal to Workflow struct
       - `List()`: Scan basePath directory (and subdirs up to 2 levels), read all .yaml files
       - `Delete()`: Remove the .yaml file from disk
       - Support folder organization: `Save()` accepts workflows with paths like `infra/deploy` which creates `basePath/infra/deploy.yaml`

    4. Create `internal/store/yaml_test.go`:
       - Use `t.TempDir()` for isolated test directories
       - Test: Save + Get round-trip with basic workflow
       - Test: Multiline command round-trip (block scalar `|` preservation)
       - Test: Norway Problem — command containing "no", "yes", "on", "off", "true", "false" survives round-trip as strings
       - Test: Command with nested quotes (`docker exec -it db psql -c "SELECT * FROM users"`) round-trips correctly
       - Test: List returns all workflows from flat and nested directories
       - Test: Delete removes file from disk
       - Test: Get returns error for non-existent workflow
       - Test: Filename slugification (spaces, special chars)
       - At least 8 test cases covering the above

    IMPORTANT: Use `github.com/goccy/go-yaml` for ALL YAML operations. Do NOT use `gopkg.in/yaml.v3` — it is unmaintained since April 2025.
  </action>
  <verify>
    `go test ./internal/store/... -v` passes all tests.
    Specifically verify: a workflow with command `redis-cli CONFIG SET appendonly no` round-trips without "no" becoming "false".
    Verify: a multiline command `echo "line1"\necho "line2"` round-trips with newlines preserved.
    `go vet ./...` passes.
  </verify>
  <done>
    Workflow domain model defined. YAML store implements full CRUD. Round-trip tests pass for normal commands, multiline commands, Norway Problem values, and nested quotes. Store supports flat and nested directory organization.
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/wf/` compiles cleanly
2. `go test ./internal/... -v` — all store tests pass
3. `go vet ./...` — no issues
4. Round-trip test explicitly covers: "no", "yes", "on", "off", "true", "false", multiline, nested quotes
5. Config resolves to XDG-compliant path (not ~/Library/Application Support on macOS)
</verification>

<success_criteria>
- Go project compiles and runs (`wf --help` works)
- Workflow struct models all required fields (name, command, description, tags, args)
- YAML store saves/loads/lists/deletes workflows from disk
- Norway Problem values in commands are NOT silently corrupted
- Multiline commands survive YAML serialization intact
- At least 8 passing tests covering edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-01-SUMMARY.md`
</output>
