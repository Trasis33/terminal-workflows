---
phase: 01-foundation-data-layer
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/template/parser.go
  - internal/template/renderer.go
  - internal/template/template_test.go
autonomous: true

must_haves:
  truths:
    - "Template parser extracts {{name}} parameters from command strings"
    - "Template parser extracts {{name:default}} parameters with default values"
    - "Duplicate parameter names are deduplicated — one parameter, fills all occurrences"
    - "Renderer substitutes all parameter occurrences with provided values"
    - "Missing parameter with no default renders with {{name}} placeholder visible"
  artifacts:
    - path: "internal/template/parser.go"
      provides: "ExtractParams function for parsing {{param}} syntax"
      exports: ["ExtractParams", "Param"]
      min_lines: 30
    - path: "internal/template/renderer.go"
      provides: "Render function for substituting parameters"
      exports: ["Render"]
      min_lines: 20
    - path: "internal/template/template_test.go"
      provides: "Comprehensive test suite for parser and renderer"
      min_lines: 100
  key_links:
    - from: "internal/template/parser.go"
      to: "internal/template/renderer.go"
      via: "shared Param type used by both"
      pattern: "type Param struct"
---

<objective>
Build the template engine that parses `{{named}}` parameters from command strings and renders them with user-provided values, using TDD for correctness.

Purpose: The template engine is the core logic that makes wf workflows parameterized. It must correctly parse `{{name}}` and `{{name:default}}` syntax, deduplicate parameters, and render substitutions — all without using Go's `text/template` (wrong syntax, security concerns, overkill). This is pure logic with clear input/output contracts — perfect for TDD.

Output: Working template parser and renderer with comprehensive test suite proving all edge cases.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-layer/01-CONTEXT.md
@.planning/research/ARCHITECTURE.md
</context>

<feature>
  <name>Template Engine: Parser + Renderer</name>
  <files>
    internal/template/parser.go
    internal/template/renderer.go
    internal/template/template_test.go
  </files>
  <behavior>
    The template engine uses simple regex parsing (NOT Go text/template). Two functions:

    **ExtractParams(command string) []Param**
    Extracts unique parameters from a command string.

    Cases:
    - `"ssh {{host}} -p {{port}}"` → `[{Name:"host"}, {Name:"port"}]`
    - `"ssh {{host:localhost}} -p {{port:22}}"` → `[{Name:"host", Default:"localhost"}, {Name:"port", Default:"22"}]`
    - `"echo {{msg}} && echo {{msg}}"` → `[{Name:"msg"}]` (deduplicated)
    - `"echo hello"` → `[]` (no params)
    - `""` → `[]` (empty string)
    - `"curl -H 'Auth: {{token}}' {{url}}/api/{{version}}/{{endpoint}}"` → 4 params
    - `"{{name:default with spaces}}"` → `[{Name:"name", Default:"default with spaces"}]`
    - `"{{a}} {{b:x}} {{a:y}}"` → `[{Name:"a", Default:"y"}, {Name:"b", Default:"x"}]` (last default wins for dupes)

    **Render(command string, values map[string]string) string**
    Substitutes parameters with values.

    Cases:
    - `Render("ssh {{host}}", {"host": "prod"})` → `"ssh prod"`
    - `Render("ssh {{host:localhost}}", {"host": "prod"})` → `"ssh prod"` (value overrides default)
    - `Render("ssh {{host:localhost}}", {})` → `"ssh localhost"` (default used when no value)
    - `Render("echo {{msg}} && echo {{msg}}", {"msg": "hi"})` → `"echo hi && echo hi"` (all occurrences)
    - `Render("ssh {{host}}", {})` → `"ssh {{host}}"` (no value + no default = placeholder stays, per CONTEXT.md)
    - `Render("echo hello", {})` → `"echo hello"` (no params = passthrough)

    Type definition:
    ```
    type Param struct {
        Name    string
        Default string
    }
    ```

    Use `regexp.MustCompile(`\{\{([^}]+)\}\}`)` as the core pattern. Split match on first `:` for name:default.
  </behavior>
  <implementation>
    Use simple regex approach (~50 lines total for parser + renderer):

    Parser:
    1. Compile regex `\{\{([^}]+)\}\}`
    2. FindAllStringSubmatch on command
    3. For each match, split inner content on first `:` — left is name, right (if exists) is default
    4. Deduplicate by name (last default wins if same name appears with different defaults)
    5. Return ordered unique []Param (order of first appearance)

    Renderer:
    1. Use regex ReplaceAllStringFunc
    2. For each `{{...}}` match, extract name (and default)
    3. Look up name in values map — use value if present, else default, else leave `{{name}}` as-is
    4. Return substituted string

    Do NOT use Go's text/template — it uses `{{.Field}}` syntax which is wrong for this use case.
  </implementation>
</feature>

<verification>
1. `go test ./internal/template/... -v` passes all tests
2. Tests cover: basic params, defaults, deduplication, empty input, no params, mixed params, missing values
3. Parser returns params in order of first appearance
4. Renderer handles all occurrences of same param
</verification>

<success_criteria>
- ExtractParams correctly parses {{name}} and {{name:default}} syntax
- Duplicate names are deduplicated (one param, fills all occurrences)
- Render substitutes all occurrences with provided values
- Missing param with no default leaves {{name}} placeholder visible
- Missing param with default uses the default value
- At least 12 test cases covering edge cases
- Zero dependency on text/template
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-02-SUMMARY.md`
</output>
