---
phase: 04-advanced-parameters-import
plan: 06
type: execute
wave: 2
depends_on: ["04-01", "04-03"]
files_modified:
  - cmd/wf/import.go
  - cmd/wf/root.go
autonomous: true

must_haves:
  truths:
    - "User can run `wf import pet snippet.toml` to convert a Pet TOML file into wf workflows"
    - "User can run `wf import warp workflow.yaml` to convert a Warp YAML file into wf workflows"
    - "Import shows a dry-run preview before writing (count, names, conflicts)"
    - "User can resolve name conflicts interactively (skip, rename, overwrite)"
    - "User can skip preview with --force flag"
    - "User can specify target folder with --folder flag"
    - "Unmappable fields are preserved as YAML comments in imported files"
  artifacts:
    - path: "cmd/wf/import.go"
      provides: "wf import cobra command with pet/warp subcommands"
      contains: "importCmd"
    - path: "cmd/wf/root.go"
      provides: "importCmd added to root command"
      contains: "importCmd"
  key_links:
    - from: "cmd/wf/import.go"
      to: "internal/importer/pet.go"
      via: "PetImporter.Import() for Pet TOML conversion"
      pattern: "PetImporter"
    - from: "cmd/wf/import.go"
      to: "internal/importer/warp.go"
      via: "WarpImporter.Import() for Warp YAML conversion"
      pattern: "WarpImporter"
    - from: "cmd/wf/import.go"
      to: "internal/store/store.go"
      via: "Store.Save() and Store.Get() for persistence and conflict detection"
      pattern: "getStore"
---

<objective>
Create the `wf import` command for importing Pet TOML and Warp YAML workflow collections, with dry-run preview and conflict handling.

Purpose: Users can migrate existing workflow collections from Pet and Warp into wf with a single command, preserving all data.
Output: Working `wf import` command with format detection, preview, conflict resolution, and YAML comment preservation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
@.planning/phases/04-advanced-parameters-import/04-01-SUMMARY.md
@.planning/phases/04-advanced-parameters-import/04-03-SUMMARY.md
@cmd/wf/add.go
@cmd/wf/root.go
@internal/store/workflow.go
@internal/store/store.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: wf import command with preview and conflict handling</name>
  <files>cmd/wf/import.go, cmd/wf/root.go</files>
  <action>
    Create `cmd/wf/import.go` with the import command.

    **Command structure:**
    - `wf import pet <file>` — import from Pet TOML format
    - `wf import warp <file>` — import from Warp YAML format

    Use cobra subcommands: `importCmd` parent with `importPetCmd` and `importWarpCmd` children.

    **Shared flags (on parent importCmd):**
    - `--force` — skip preview, import directly
    - `--folder <path>` — target folder for imported workflows (prepended to workflow names)

    **Flow (same for both formats):**

    1. Open and read the source file.
    2. Create the appropriate importer (PetImporter or WarpImporter).
    3. Call importer.Import(reader) → ImportResult.
    4. Report parse results: "Parsed N workflows (M warnings, K errors)".
    5. If errors, print each error. If all entries failed, abort.

    6. **Conflict detection:**
       - For each workflow in result.Workflows:
         - If --folder specified, prepend folder path to workflow name.
         - Check store.Get(workflow.Name) for existing workflow.
         - Mark as conflict if exists.

    7. **Preview (unless --force):**
       - Print table: "Import preview:"
         - Name | Status (new / conflict)
       - Print warnings (unmappable fields).
       - For each conflict, prompt interactively:
         "Conflict: '<name>' already exists. [s]kip / [r]ename / [o]verwrite: "
         - skip: remove from import list
         - rename: prompt for new name, update workflow
         - overwrite: keep in import list (will overwrite)
       - Print "Proceed with import? (y/n): "
       - If no, abort.

    8. **Save workflows:**
       - For each workflow to import:
         - If warnings exist for this workflow (unmappable fields), inject them as YAML comment header.
           To preserve unmappable fields as YAML comments: after calling store.Save(), read the saved file, prepend comment lines, write back. Each warning becomes a `# <warning>` line at the top of the YAML file.
         - Save via getStore().Save().
       - Print "Imported N workflows" with summary.

    **YAML comment preservation for unmappable fields:**
    The ImportResult.Warnings are strings like "output: some output text" (for Pet) or "source_url: https://..." (for Warp). After saving each workflow, read the YAML file back, prepend lines like:
    ```
    # Imported from Pet — unmappable fields:
    # output: some output text
    ```
    Then write the file back. Use getStore().WorkflowPath(name) to find the file path.

    Wire importCmd (with pet and warp subcommands) in root.go init().
  </action>
  <verify>
    ```bash
    go build ./cmd/wf/
    ./wf import --help
    ./wf import pet --help
    ./wf import warp --help
    ```
    Verify help text shows correct usage and flags.
  </verify>
  <done>
    - `wf import pet file.toml` parses Pet TOML and imports workflows
    - `wf import warp file.yaml` parses Warp YAML and imports workflows
    - Preview shows workflow count, names, and conflicts before importing
    - Conflicts prompt for skip/rename/overwrite per-entry
    - `--force` skips preview and conflict prompts
    - `--folder` prepends path to imported workflow names
    - Unmappable fields preserved as YAML comments
    - importCmd wired in root.go
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification</name>
  <files></files>
  <action>
    Verify all Phase 4 features work end-to-end:

    1. **Enum parameters:**
       ```bash
       ./wf add -n "deploy-enum" -c "deploy --env {{env|dev|staging|*prod}}" -d "Deploy to environment"
       ./wf list
       ```
       Verify the workflow is saved with the enum syntax preserved in the YAML file.

    2. **Dynamic parameters:**
       ```bash
       ./wf add -n "checkout-dynamic" -c "git checkout {{branch!git branch --list}}" -d "Checkout git branch"
       ./wf list
       ```
       Verify the workflow is saved with the dynamic syntax preserved.

    3. **Register command:**
       ```bash
       ./wf register 'curl -X GET https://api.example.com/v1/users'
       ```
       Enter name "test-register", description "Test registered workflow". Verify auto-detection suggests URL as parameter. Verify workflow is saved.

    4. **Import (create test files then import):**
       Create a small Pet TOML test file and Warp YAML test file in /tmp, then:
       ```bash
       ./wf import pet /tmp/test-pet.toml
       ./wf import warp /tmp/test-warp.yaml
       ./wf list
       ```
       Verify imported workflows appear in list.

    5. **Full test suite:**
       ```bash
       go test ./... -count=1
       go vet ./...
       ```
       All tests pass, no vet issues.

    6. **Build verification:**
       ```bash
       go build -o /dev/null ./cmd/wf/
       ```
       Clean build with no warnings.
  </action>
  <verify>
    ```bash
    go test ./... -count=1
    go vet ./...
    go build ./cmd/wf/
    ```
  </verify>
  <done>
    - All Phase 4 features compile and run
    - Enum/dynamic params saved correctly in YAML
    - wf register captures and saves commands
    - wf import converts Pet/Warp formats correctly
    - Full test suite passes
    - No vet warnings
  </done>
</task>

</tasks>

<verification>
```bash
go test ./... -count=1
go vet ./...
go build ./cmd/wf/
./wf --version
```
</verification>

<success_criteria>
- `wf import pet` and `wf import warp` commands work end-to-end
- Dry-run preview shows count and conflicts
- Interactive conflict resolution works (skip/rename/overwrite)
- --force and --folder flags work correctly
- Unmappable fields preserved as YAML comments in imported files
- All Phase 4 features verified working together
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-06-SUMMARY.md`
</output>
