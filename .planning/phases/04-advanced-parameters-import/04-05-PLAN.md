---
phase: 04-advanced-parameters-import
plan: 05
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - cmd/wf/register.go
  - cmd/wf/root.go
  - internal/register/detect.go
  - internal/register/detect_test.go
autonomous: true

must_haves:
  truths:
    - "User can run `wf register` to capture the last shell command as a workflow"
    - "User can run `wf register 'some command'` to register a specific command directly"
    - "User can run `wf register --pick` to browse and select from recent shell history"
    - "Parameter auto-detection suggests obvious patterns (IPs, ports, paths, URLs) as {{parameters}}"
    - "User is prompted for name and description (same interactive pattern as `wf add`)"
    - "Registered workflow is saved to disk as a valid YAML file"
  artifacts:
    - path: "cmd/wf/register.go"
      provides: "wf register cobra command with --pick flag"
      contains: "registerCmd"
    - path: "internal/register/detect.go"
      provides: "Auto-detection of parameterizable patterns in commands"
      contains: "DetectParams"
    - path: "internal/register/detect_test.go"
      provides: "Tests for parameter auto-detection"
      min_lines: 40
    - path: "cmd/wf/root.go"
      provides: "registerCmd added to root command"
      contains: "registerCmd"
  key_links:
    - from: "cmd/wf/register.go"
      to: "internal/history/history.go"
      via: "HistoryReader.Last() and LastN() for command capture"
      pattern: "history\\.NewReader"
    - from: "cmd/wf/register.go"
      to: "internal/register/detect.go"
      via: "DetectParams suggests parameters from command string"
      pattern: "DetectParams"
    - from: "cmd/wf/register.go"
      to: "internal/store/store.go"
      via: "Store.Save() to persist the new workflow"
      pattern: "Save"
---

<objective>
Create the `wf register` command that captures previous shell commands and saves them as workflows with auto-detected parameters.

Purpose: Users can "quick save" commands they've already typed — grab from history, auto-detect parameters, answer a few prompts, and it's saved as a reusable workflow.
Output: Working `wf register` command with history capture, `--pick` mode, and parameter auto-detection.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
@.planning/phases/04-advanced-parameters-import/04-01-SUMMARY.md
@.planning/phases/04-advanced-parameters-import/04-02-SUMMARY.md
@cmd/wf/add.go
@cmd/wf/root.go
@internal/store/workflow.go
@internal/store/store.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parameter auto-detection package</name>
  <files>internal/register/detect.go, internal/register/detect_test.go</files>
  <action>
    Create `internal/register/` package with parameter auto-detection.

    `DetectParams(command string) []Suggestion` scans a command string for obvious parameterizable patterns and returns suggestions.

    Suggestion struct:
    - Original string — the matched text
    - ParamName string — suggested parameter name
    - Start, End int — position in command string

    Detection patterns (conservative — avoid false positives):
    - IPv4 addresses: `\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b` → suggest name "ip" or "host"
    - Ports: `(?::)(\d{4,5})\b` (4-5 digit numbers after colon) → suggest name "port"
    - URLs: `https?://\S+` → suggest name "url"
    - Absolute paths: `/[\w./-]+` (3+ chars after /) → suggest name "path"
    - ALL_CAPS values: `\b[A-Z][A-Z0-9_]{2,}\b` (3+ chars, not common commands) → suggest param name as lowercase of value
    - Email-like: `\b[\w.]+@[\w.]+\.\w+\b` → suggest name "email"

    Exclude common false positives: HTTP, HTTPS, GET, POST, PUT, DELETE, HEAD, SSH, SCP, NULL, TRUE, FALSE, EOF, etc. as ALL_CAPS.

    Write tests for each pattern type, including false positive exclusion.
  </action>
  <verify>
    ```bash
    go test ./internal/register/ -v -count=1
    go vet ./internal/register/
    ```
  </verify>
  <done>
    - DetectParams identifies IPs, ports, URLs, paths, ALL_CAPS values in commands
    - False positives (common shell/HTTP keywords) are excluded
    - Tests cover all detection patterns and edge cases
  </done>
</task>

<task type="auto">
  <name>Task 2: wf register cobra command</name>
  <files>cmd/wf/register.go, cmd/wf/root.go</files>
  <action>
    Create `cmd/wf/register.go` with the register command.

    **Usage patterns:**
    1. `wf register` — no args, grabs last command from shell history
    2. `wf register 'docker run -p 8080:80 nginx'` — direct command input (args joined with spaces)
    3. `wf register --pick` — browse last 15 history entries, select one

    **Flow:**
    1. Determine command source:
       - If `--pick` flag: use history.NewReader(), call LastN(15), display numbered list, prompt user to select one (bufio.Scanner, same interactive pattern as wf add).
       - If args provided: join args with space as the command.
       - If no args, no --pick: use history.NewReader(), call Last() for the most recent command.
       - Print "Captured: <command>" for confirmation.

    2. Auto-detect parameters:
       - Call register.DetectParams(command) to get suggestions.
       - If suggestions found, display them numbered: "Detected potential parameters:"
         "1. 192.168.1.1 → {{ip}}"
         "2. 8080 → {{port}}"
       - Prompt: "Apply all? (y/n/select numbers): "
         - "y" → apply all substitutions to command
         - "n" → skip, keep command as-is
         - "1,3" → apply only selected substitutions
       - After applying, let user review the final command.

    3. Collect metadata (same interactive pattern as wf add):
       - Prompt for name (required), description (optional), tags (optional, comma-separated).
       - Use bufio.Scanner for prompts, matching wf add's existing interactive style.

    4. Build and save workflow:
       - Create store.Workflow with collected fields.
       - Auto-extract Args from final command using template.ExtractParams.
       - Save via getStore().Save().
       - Print "Created <name>".

    **Flags:**
    - `--pick` — browse history entries

    **Error handling:**
    - History read failure: print error, suggest using `wf register 'command'` directly
    - No history entries: print "No history found" with suggestion
    - Empty command after selection: error "no command to register"

    Wire registerCmd in root.go init().
  </action>
  <verify>
    ```bash
    go build ./cmd/wf/
    ./wf register --help
    ```
    Verify help text shows usage patterns and --pick flag.
  </verify>
  <done>
    - `wf register` captures last shell command
    - `wf register 'cmd'` takes direct input
    - `wf register --pick` shows history browser
    - Parameter auto-detection suggests and applies substitutions
    - Interactive metadata collection (name, description, tags)
    - Workflow saved to disk
    - registerCmd wired in root.go
  </done>
</task>

</tasks>

<verification>
```bash
go build ./cmd/wf/
go test ./internal/register/ -v -count=1
go test ./cmd/wf/ -v -count=1
./wf register --help
```
</verification>

<success_criteria>
- `wf register` captures last command from shell history
- `wf register 'command here'` accepts direct command input
- `wf register --pick` shows numbered history list for selection
- Auto-detected parameters are suggested and user can selectively apply
- Interactive prompts collect name and description
- Workflow is saved as valid YAML file
- `go build ./cmd/wf/` compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-05-SUMMARY.md`
</output>
