---
phase: 04-advanced-parameters-import
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/history/history.go
  - internal/history/zsh.go
  - internal/history/bash.go
  - internal/history/fish.go
  - internal/history/detect.go
  - internal/history/history_test.go
autonomous: true

must_haves:
  truths:
    - "Zsh extended history entries are parsed correctly with timestamps"
    - "Zsh plain history (no EXTENDED_HISTORY) is parsed correctly"
    - "Zsh metafied encoding (0x83 meta-byte) is decoded correctly"
    - "Bash history is parsed with and without HISTTIMEFORMAT timestamps"
    - "Fish pseudo-YAML history is parsed line-by-line (not via YAML parser)"
    - "Multiline commands in zsh/bash are reconstructed as single entries"
    - "Current shell is auto-detected from $SHELL with HISTFILE override"
  artifacts:
    - path: "internal/history/history.go"
      provides: "HistoryReader interface with LastN and Last methods, HistoryEntry struct"
      exports: ["HistoryReader", "HistoryEntry", "NewReader"]
    - path: "internal/history/zsh.go"
      provides: "Zsh history parser with unmetafy and extended/plain format detection"
      contains: "unmetafy"
    - path: "internal/history/bash.go"
      provides: "Bash history parser with timestamp detection"
      contains: "parseBashHistory"
    - path: "internal/history/fish.go"
      provides: "Fish history parser with line-by-line pseudo-YAML parsing"
      contains: "parseFishHistory"
    - path: "internal/history/detect.go"
      provides: "Shell auto-detection from $SHELL env var"
      contains: "DetectShell"
    - path: "internal/history/history_test.go"
      provides: "Tests for all three shell parsers and edge cases"
      min_lines: 150
  key_links:
    - from: "internal/history/detect.go"
      to: "internal/history/zsh.go"
      via: "NewReader factory returns shell-specific reader"
      pattern: "NewReader"
---

<objective>
Create the shell history package with parsers for zsh, bash, and fish history files, plus shell auto-detection.

Purpose: Foundation for `wf register` — must read shell history to capture previous commands.
Output: Tested history package with HistoryReader interface and three shell implementations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
</context>

<feature>
  <name>Shell History Parsers</name>
  <files>internal/history/history.go, internal/history/zsh.go, internal/history/bash.go, internal/history/fish.go, internal/history/detect.go, internal/history/history_test.go</files>
  <behavior>
    HistoryReader interface:
    - LastN(n int) ([]HistoryEntry, error) — returns last n commands, newest first
    - Last() (HistoryEntry, error) — returns most recent command

    HistoryEntry struct:
    - Command string
    - Timestamp time.Time (zero value if unavailable)

    NewReader() factory — auto-detects shell, returns appropriate reader.

    Zsh parser test cases:
    - Extended format ": 1471766804:3;git push origin master" → {Command:"git push origin master", Timestamp:2016-08-21T...}
    - Plain format "git status" → {Command:"git status", Timestamp:zero}
    - Mixed format auto-detection (extended lines + plain lines in same file)
    - Multiline: extended entry followed by continuation line (no `: ` prefix) → single joined command
    - Metafied bytes: 0x83 followed by byte → XOR with 0x20 to decode
    - Empty file → empty slice, no error
    - LastN(3) from 10-entry file → last 3 entries

    Bash parser test cases:
    - Plain format (one per line) → entries with zero timestamps
    - Timestamped format "#1678886400\nls -la" → {Command:"ls -la", Timestamp:2023-03-15T...}
    - Empty lines skipped
    - Non-numeric # lines treated as commands (comments in bash_history are just commands starting with #)
    - LastN(5) from 20-entry file → last 5 entries

    Fish parser test cases:
    - "- cmd: git push\n  when: 1678886400" → {Command:"git push", Timestamp:2023-03-15T...}
    - Entry without when: line → zero timestamp
    - Multiple entries parsed in order
    - paths: section ignored (no impact on command)
    - LastN(2) from 5-entry file → last 2 entries

    Shell detection test cases:
    - $SHELL="/bin/zsh" → "zsh"
    - $SHELL="/usr/local/bin/fish" → "fish"
    - $SHELL="/bin/bash" → "bash"
    - $SHELL="" → "bash" (fallback)
    - $HISTFILE override → used instead of default path
  </behavior>
  <implementation>
    RED: Write test cases for all three parsers using embedded test data (string literals, not files). Test shell detection with env var mocking. All tests MUST fail.

    GREEN:
    1. Create internal/history/history.go — HistoryEntry struct, HistoryReader interface, NewReader factory.
    2. Create internal/history/zsh.go — unmetafy([]byte) []byte, parseZshExtended, zshReader struct implementing HistoryReader. Read file as bytes, unmetafy, then parse. Auto-detect extended vs plain per-line (lines starting with ": " + digits).
    3. Create internal/history/bash.go — parseBashHistory, bashReader struct. Detect timestamp lines (# + pure digits).
    4. Create internal/history/fish.go — parseFishHistory (line-by-line, NOT yaml.Unmarshal), fishReader struct.
    5. Create internal/history/detect.go — DetectShell() string from $SHELL basename, historyFilePath() with $HISTFILE override, default paths per shell.
    6. Run tests — all MUST pass.

    REFACTOR: Ensure consistent error handling (file not found → empty results with error, parse errors → skip malformed entries with warning).

    IMPORTANT: All parsers accept []byte or io.Reader for testability — don't require actual files in tests. The HistoryReader wraps file I/O around the parser functions.
  </implementation>
</feature>

<verification>
```bash
go test ./internal/history/ -v -count=1
go vet ./internal/history/
```
</verification>

<success_criteria>
- All zsh parser tests pass (extended, plain, mixed, multiline, metafied)
- All bash parser tests pass (plain, timestamped, edge cases)
- All fish parser tests pass (pseudo-YAML, missing when, paths ignored)
- Shell detection works for zsh/bash/fish with $SHELL and $HISTFILE
- LastN returns entries newest-first, correctly sliced
- No file I/O in tests (embedded test data only)
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-02-SUMMARY.md`
</output>
