---
phase: 04-advanced-parameters-import
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/picker/paramfill.go
  - internal/picker/model.go
autonomous: true

must_haves:
  truths:
    - "User sees a vertical list selector for enum parameters instead of free-text input"
    - "User can navigate enum options with arrow keys and select with Enter"
    - "Enum default option is pre-selected when parameter has asterisk-marked default"
    - "Dynamic parameter executes its shell command and populates a list selector with stdout lines"
    - "Dynamic parameter shows a loading indicator while command runs (up to 5s timeout)"
    - "Dynamic parameter falls back to free-text input if command fails or times out"
    - "Text parameters behave identically to before (backward compatible)"
    - "Live command preview updates as user selects enum/dynamic options"
  artifacts:
    - path: "internal/picker/paramfill.go"
      provides: "Extended parameter fill with enum list select and dynamic exec"
      contains: "ParamEnum"
    - path: "internal/picker/model.go"
      provides: "Updated model fields for enum/dynamic parameter state"
      contains: "paramTypes"
  key_links:
    - from: "internal/picker/paramfill.go"
      to: "internal/template/parser.go"
      via: "Reads Param.Type to determine input widget type"
      pattern: "ParamEnum|ParamDynamic"
---

<objective>
Extend the picker's parameter fill UI to support enum (list select) and dynamic (shell-executed list) parameter types.

Purpose: Users need to interact with enum and dynamic parameters during the quick picker flow — selecting from predefined or dynamically-generated option lists rather than free-text input.
Output: Updated paramfill with enum list selector, dynamic command execution with spinner/fallback, and backward-compatible text input.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
@.planning/phases/04-advanced-parameters-import/04-01-SUMMARY.md
@internal/picker/paramfill.go
@internal/picker/model.go
@internal/picker/styles.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enum and dynamic parameter fill UI</name>
  <files>internal/picker/paramfill.go, internal/picker/model.go</files>
  <action>
    Extend the parameter fill flow to handle three parameter types:

    **Model changes (model.go):**
    - Add field to Model: `paramTypes []template.ParamType` — parallel to paramInputs, tracks type per param
    - Add field: `paramOptions [][]string` — options for enum/dynamic params (nil for text)
    - Add field: `paramOptionCursor []int` — cursor position within each param's option list
    - Add field: `paramLoading []bool` — true while dynamic command is executing
    - Add field: `paramFailed []bool` — true if dynamic command failed (fallback to text)

    **initParamFill changes (paramfill.go):**
    - After extracting params, check each Param.Type:
      - ParamText: create textinput as before
      - ParamEnum: create textinput but set it read-only (cursor hidden). Store options in paramOptions[i]. If Param.Default is set, find its index in options and set paramOptionCursor[i]. Set textinput value to the selected option.
      - ParamDynamic: create textinput (starts as loading placeholder). Set paramLoading[i]=true. Fire a tea.Cmd to execute the dynamic command asynchronously.

    **Dynamic command execution:**
    - Create a message type `dynamicResultMsg` with param index, options []string, error.
    - Execute via `exec.CommandContext` with 5-second timeout in a goroutine wrapped as tea.Cmd.
    - On success: parse stdout line-by-line into options, populate paramOptions[i], set textinput value to first option, clear paramLoading[i].
    - On failure/timeout: set paramFailed[i]=true, clear paramLoading[i], leave textinput as free-text input.

    **updateParamFill changes:**
    - For enum params (and successful dynamic params): up/down arrows cycle through paramOptions[i], updating paramOptionCursor[i] and textinput value. Enter on enum confirms selection and advances.
    - For text params (and failed dynamic params): unchanged behavior (free-text input with tab/enter navigation).
    - Tab/shift+tab: works across all param types as before.

    **viewParamFill changes:**
    - For enum params: render the option list vertically with cursor indicator (❯) on selected option. Show all options (or scroll if >5 options).
    - For dynamic params in loading state: show spinner text "Loading..." with the dynamic command name.
    - For dynamic params with options: render same as enum.
    - For dynamic params that failed: show error note and render as text input.
    - For text params: unchanged rendering.

    **liveRender changes:**
    - For enum/dynamic params, read value from textinput (which is set to selected option). No change needed — textinput.Value() already returns the right string.

    Keep the UX simple: enum parameters show an inline option list below the param label. Arrow keys (up/down) cycle options. The selected option value is placed in the textinput for live preview. This avoids a separate list widget and keeps the flow consistent.

    Use `os/exec` with `context.WithTimeout(context.Background(), 5*time.Second)` for dynamic commands. Parse stdout with `bufio.Scanner`, trim whitespace, skip empty lines.
  </action>
  <verify>
    ```bash
    go build ./cmd/wf/
    go vet ./internal/picker/
    ```
    Manual test: Create a workflow with enum params `wf add -n "test-enum" -c "deploy {{env|dev|staging|*prod}}"`, then `wf pick` and verify enum selection UI appears.
    Manual test: Create a workflow with dynamic params `wf add -n "test-dynamic" -c "git checkout {{branch!git branch --list}}"`, then `wf pick` and verify dynamic options load.
  </verify>
  <done>
    - Enum parameters show vertical option list with arrow-key navigation
    - Dynamic parameters execute shell command, show spinner, populate option list
    - Dynamic failure falls back to text input without blocking
    - Text parameters work identically to before
    - Live preview updates as user selects enum/dynamic options
    - Tab/shift+tab navigates between all parameter types
    - `go build` compiles cleanly
  </done>
</task>

</tasks>

<verification>
```bash
go build ./cmd/wf/
go test ./internal/picker/ -v -count=1
go vet ./internal/picker/
```
</verification>

<success_criteria>
- Enum parameters display selectable option list in paramfill UI
- Dynamic parameters execute command and populate options (or fall back to text)
- All three param types (text, enum, dynamic) coexist in a single workflow's paramfill
- Backward compatibility — workflows with only text params work identically
- `go build ./cmd/wf/` compiles and runs
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-04-SUMMARY.md`
</output>
