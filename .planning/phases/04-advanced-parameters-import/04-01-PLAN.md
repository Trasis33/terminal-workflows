---
phase: 04-advanced-parameters-import
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/template/parser.go
  - internal/template/renderer.go
  - internal/template/template_test.go
  - internal/store/workflow.go
autonomous: true

must_haves:
  truths:
    - "Parser extracts enum parameters from pipe-delimited inline syntax ({{env|dev|staging|*prod}})"
    - "Parser extracts dynamic parameters from bang syntax ({{branch!git branch --list}})"
    - "Parser preserves backward compatibility — existing {{name}} and {{name:default}} syntax works identically"
    - "Render() substitutes enum and dynamic params by name like text params"
    - "Arg struct serializes to/from YAML with type, options, and dynamic_cmd fields"
  artifacts:
    - path: "internal/template/parser.go"
      provides: "Extended parseInner with ParamType discrimination (bang → pipe → colon → plain)"
      contains: "ParamEnum"
    - path: "internal/template/template_test.go"
      provides: "Tests for enum, dynamic, and backward-compatible parsing"
      min_lines: 200
    - path: "internal/store/workflow.go"
      provides: "Arg struct with Type, Options, DynamicCmd fields"
      contains: "DynamicCmd"
  key_links:
    - from: "internal/template/parser.go"
      to: "internal/template/renderer.go"
      via: "parseInner used by both ExtractParams and Render"
      pattern: "parseInner"
---

<objective>
Extend the template parser to support enum and dynamic parameter types, and extend the Arg struct for YAML persistence of these new types.

Purpose: Foundation for all Phase 4 enum/dynamic parameter features — parser must correctly discriminate parameter types before UI or commands can use them.
Output: Extended parser with TDD coverage, extended Arg struct, backward-compatible Render.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
@internal/template/parser.go
@internal/template/renderer.go
@internal/template/template_test.go
@internal/store/workflow.go
</context>

<feature>
  <name>Enum and Dynamic Parameter Parsing</name>
  <files>internal/template/parser.go, internal/template/renderer.go, internal/template/template_test.go, internal/store/workflow.go</files>
  <behavior>
    Extend parseInner() with priority-ordered type discrimination:
    1. Bang `!` → ParamDynamic (name!command)
    2. Pipe `|` → ParamEnum (name|opt1|opt2|*default)
    3. Colon `:` → ParamText with default (existing behavior)
    4. Plain → ParamText without default (existing behavior)

    The Param struct gains: Type (ParamType iota: ParamText, ParamEnum, ParamDynamic), Options []string, DynamicCmd string.

    Test cases (input → expected output):

    Enum parsing:
    - "{{env|dev|staging|prod}}" → Param{Name:"env", Type:ParamEnum, Options:["dev","staging","prod"]}
    - "{{env|dev|staging|*prod}}" → Param{Name:"env", Type:ParamEnum, Options:["dev","staging","prod"], Default:"prod"}
    - "{{size|s|m|*l|xl}}" → Param{Name:"size", Type:ParamEnum, Options:["s","m","l","xl"], Default:"l"}

    Dynamic parsing:
    - "{{branch!git branch --list}}" → Param{Name:"branch", Type:ParamDynamic, DynamicCmd:"git branch --list"}
    - "{{ns!kubectl get ns -o name}}" → Param{Name:"ns", Type:ParamDynamic, DynamicCmd:"kubectl get ns -o name"}
    - "{{branch!git branch | grep feature}}" → Param{Name:"branch", Type:ParamDynamic, DynamicCmd:"git branch | grep feature"} (pipe in shell command, NOT enum)

    Backward compatibility:
    - "{{host}}" → Param{Name:"host", Type:ParamText} (unchanged)
    - "{{host:localhost}}" → Param{Name:"host", Type:ParamText, Default:"localhost"} (unchanged)
    - "{{url:http://localhost:8080}}" → Param{Name:"url", Type:ParamText, Default:"http://localhost:8080"} (colon in default, unchanged)

    Edge cases:
    - "{{env|dev:3000|staging:8080|*prod:443}}" → ParamEnum with options ["dev:3000","staging:8080","prod:443"] (colons literal in enum mode)
    - Deduplicated enum params: "{{env|a|b}} ... {{env|a|b}}" → single Param

    Render behavior:
    - Render("deploy {{env|dev|staging|*prod}}", {"env":"staging"}) → "deploy staging"
    - Render("checkout {{branch!git branch}}", {"branch":"main"}) → "checkout main"
    - Render("deploy {{env|dev|*prod}}", {}) → "deploy prod" (enum default used)
    - Render("checkout {{branch!git branch}}", {}) → "checkout {{branch!git branch}}" (no default, placeholder stays)

    Arg struct extension:
    - Add Type string `yaml:"type,omitempty"` — "text" (default/omitted), "enum", "dynamic"
    - Add Options []string `yaml:"options,omitempty"` — for enum args
    - Add DynamicCmd string `yaml:"dynamic_cmd,omitempty"` — for dynamic args
  </behavior>
  <implementation>
    RED: Write all test cases first (enum parsing, dynamic parsing, backward compat, edge cases, render with new types). Tests MUST fail.

    GREEN:
    1. Add ParamType iota (ParamText, ParamEnum, ParamDynamic) to parser.go
    2. Extend Param struct with Type, Options, DynamicCmd fields
    3. Rewrite parseInner() — keep the (name, def string) return signature BUT change it to return a full Param. This means changing ExtractParams to use the new return. Priority: check `!` first (IndexByte), then `|` (IndexByte), then `:` (existing), then plain.
    4. Update Render() — parseInner now returns Param, extract name and default from it. For enum defaults, use Param.Default. For dynamic, no default (placeholder stays).
    5. Extend Arg struct in store/workflow.go with Type, Options, DynamicCmd YAML fields.
    6. Run tests — all MUST pass.

    REFACTOR: Clean up if needed. Ensure parseInner has clear comments about priority order and why (dynamic commands can contain pipes).

    IMPORTANT: parseInner currently returns (name, def string). Change it to return a Param directly. Update all callers (ExtractParams and Render).
  </implementation>
</feature>

<verification>
```bash
go test ./internal/template/ -v -count=1
go test ./internal/store/ -v -count=1
go build ./cmd/wf/
```
</verification>

<success_criteria>
- All existing parser tests still pass (backward compatibility)
- New enum tests pass: pipe-delimited options, asterisk default marker, colons literal in enum mode
- New dynamic tests pass: bang syntax, shell commands with pipes parsed correctly
- Render handles enum defaults and dynamic placeholders correctly
- Arg struct has Type, Options, DynamicCmd fields with proper YAML tags
- `go build ./cmd/wf/` compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-01-SUMMARY.md`
</output>
