---
phase: 04-advanced-parameters-import
plan: "07"
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/importer/pet.go
  - internal/importer/importer_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "wf import pet <file> succeeds when tag field is a bare TOML string (e.g. tag = 'k8s')"
    - "wf import pet <file> still succeeds when tag field is a TOML array (e.g. tag = ['k8s', 'deploy'])"
    - "go test ./internal/importer/... passes with no failures"
  artifacts:
    - path: "internal/importer/pet.go"
      provides: "PetSnippet.Tag as interface{} with post-unmarshal normalizeTag helper"
      contains: "normalizeTag"
    - path: "internal/importer/importer_test.go"
      provides: "Regression tests for bare-string and array-form tag input"
      contains: "TestPetImport_BareStringTag"
  key_links:
    - from: "internal/importer/pet.go"
      to: "PetSnippet.Tag"
      via: "interface{} field + normalizeTag() called in Import()"
      pattern: "normalizeTag"
---

<objective>
Make PetSnippet.Tag tolerate both a bare TOML string and a TOML array, so real-world hand-edited Pet files with `tag = "k8s"` parse without error.

Purpose: Unblocks `wf import pet` for any Pet file using single-string tag syntax — the most common format in hand-edited snippets files in the wild.
Output: Modified `pet.go` using `interface{}` for the Tag field plus a `normalizeTag` helper, and regression tests in `importer_test.go` covering both input forms.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-advanced-parameters-import/04-UAT.md

@internal/importer/pet.go
@internal/importer/importer_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change PetSnippet.Tag to interface{} and add normalizeTag helper</name>
  <files>internal/importer/pet.go</files>
  <action>
The go-toml v2 custom unmarshaler interface (`unstable.Unmarshaler`) requires a Decoder with `EnableUnmarshalerInterface()` enabled — it does NOT fire when using the top-level `toml.Unmarshal()` function. Do NOT use any custom `UnmarshalTOML` method. Use `interface{}` instead and normalize after unmarshaling.

**Step 1 — Change the Tag field in PetSnippet:**

```go
type PetSnippet struct {
    Description string      `toml:"description"`
    Command     string      `toml:"command"`
    Tag         interface{} `toml:"tag"`  // accepts both string and []interface{}
    Output      string      `toml:"output"`
}
```

Remove any existing `StringSlice` type definition if present.

**Step 2 — Add the normalizeTag helper** (add it as a package-level function, just before or after the `Import` function):

```go
// normalizeTag converts the raw TOML tag value (which may be a bare string or
// an array) into a []string. Returns nil for absent or empty values.
func normalizeTag(v interface{}) []string {
    switch t := v.(type) {
    case string:
        if t == "" {
            return nil
        }
        return []string{t}
    case []interface{}:
        out := make([]string, 0, len(t))
        for _, s := range t {
            if str, ok := s.(string); ok && str != "" {
                out = append(out, str)
            }
        }
        return out
    default:
        return nil
    }
}
```

**Step 3 — Update the call site in Import():**

Find the line that sets `Tags:` from `snippet.Tag` and replace it:

```go
// Before:
Tags: snippet.Tag     // or Tags: []string(snippet.Tag)

// After:
Tags: normalizeTag(snippet.Tag),
```

Do not change any other logic in the file. Remove any import of `fmt` that was only used by a removed `UnmarshalTOML` method (leave `fmt` if it is still used elsewhere).
  </action>
  <verify>go build ./internal/importer/ && echo "build ok"</verify>
  <done>Package compiles cleanly. PetSnippet.Tag is interface{}, normalizeTag exists, Import() calls normalizeTag(snippet.Tag).</done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for bare-string and array-form tags</name>
  <files>internal/importer/importer_test.go</files>
  <action>
Add two new tests immediately after the existing `TestPetImport_TagsCopied` test (around line 189).

**Test 1 — bare string tag:**

```go
func TestPetImport_BareStringTag(t *testing.T) {
    input := `
[[snippets]]
  description = "K8s snippet"
  command     = "kubectl get pods"
  tag         = "k8s"
  output      = ""
`
    imp := &PetImporter{}
    result, err := imp.Import(strings.NewReader(input))
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
    if len(result.Workflows) != 1 {
        t.Fatalf("expected 1 workflow, got %d", len(result.Workflows))
    }
    want := []string{"k8s"}
    assert.Equal(t, want, result.Workflows[0].Tags)
}
```

**Test 2 — array tag (regression guard to confirm arrays still work):**

```go
func TestPetImport_ArrayTag(t *testing.T) {
    input := `
[[snippets]]
  description = "Deploy snippet"
  command     = "kubectl apply -f deployment.yaml"
  tag         = ["k8s", "deploy"]
  output      = ""
`
    imp := &PetImporter{}
    result, err := imp.Import(strings.NewReader(input))
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
    if len(result.Workflows) != 1 {
        t.Fatalf("expected 1 workflow, got %d", len(result.Workflows))
    }
    want := []string{"k8s", "deploy"}
    assert.Equal(t, want, result.Workflows[0].Tags)
}
```

Do not modify any existing tests.
  </action>
  <verify>go test ./internal/importer/... -v</verify>
  <done>Both TestPetImport_BareStringTag and TestPetImport_ArrayTag pass. Tags are correctly normalized in each case.</done>
</task>

</tasks>

<verification>
Run the full importer test suite:

```
go test ./internal/importer/... -v
```

Expected: all tests pass including the new `TestPetImport_BareStringTag` and `TestPetImport_ArrayTag`.

Manual smoke test (optional):
```bash
cat > /tmp/pet-bare-tag.toml << 'EOF'
[[snippets]]
  description = "K8s get pods"
  command = "kubectl get pods -n <namespace=default>"
  tag = "k8s"
  output = ""
EOF
go run ./cmd/wf import pet /tmp/pet-bare-tag.toml
```
Expected: preview table shown, no parse error, workflow saved with tag `k8s`.
</verification>

<success_criteria>
- `go test ./internal/importer/... -v` exits 0 with all tests passing
- `TestPetImport_BareStringTag` exists and passes (bare string `"k8s"` → `[]string{"k8s"}`)
- `TestPetImport_ArrayTag` exists and passes (array `["k8s","deploy"]` → `[]string{"k8s","deploy"}`)
- All pre-existing `TestPetImport_*` tests still pass (no regressions)
- `internal/importer/pet.go` compiles cleanly (`go build ./...`)
- `PetSnippet.Tag` is `interface{}` (NOT `StringSlice` or `[]string`)
- No `UnmarshalTOML` method anywhere in the importer package
- `normalizeTag(v interface{}) []string` helper exists and is called from `Import()`
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-07-SUMMARY.md` following the standard summary template.
</output>
