---
phase: 04-advanced-parameters-import
plan: "07"
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/importer/pet.go
  - internal/importer/importer_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "wf import pet <file> succeeds when tag field is a bare TOML string (e.g. tag = 'k8s')"
    - "wf import pet <file> still succeeds when tag field is a TOML array (e.g. tag = ['k8s', 'deploy'])"
    - "go test ./internal/importer/... passes with no failures"
  artifacts:
    - path: "internal/importer/pet.go"
      provides: "StringSlice type with UnmarshalTOML accepting both string and []string"
      contains: "UnmarshalTOML"
    - path: "internal/importer/importer_test.go"
      provides: "Regression test for bare-string tag input"
      contains: "TestPetImport_BareStringTag"
  key_links:
    - from: "internal/importer/pet.go"
      to: "PetSnippet.Tag"
      via: "StringSlice.UnmarshalTOML"
      pattern: "UnmarshalTOML"
---

<objective>
Make PetSnippet.Tag tolerate both a bare TOML string and a TOML array, so real-world hand-edited Pet files with `tag = "k8s"` parse without error.

Purpose: Unblocks `wf import pet` for any Pet file using single-string tag syntax — the most common format in hand-edited snippets files in the wild.
Output: Modified `pet.go` with a `StringSlice` custom type + a regression test in `importer_test.go`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-advanced-parameters-import/04-UAT.md

@internal/importer/pet.go
@internal/importer/importer_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StringSlice type with lenient TOML unmarshaler to pet.go</name>
  <files>internal/importer/pet.go</files>
  <action>
Define a new type `StringSlice []string` in `internal/importer/pet.go`, before the `PetFile` struct.

Implement `UnmarshalTOML(fn func(any) error) error` on `*StringSlice`. The method must:
1. Try unmarshaling as `[]string` first — if that succeeds, assign and return nil.
2. If that fails, try unmarshaling as a bare `string` — if that succeeds, set `*s = StringSlice{str}` and return nil.
3. If both attempts fail, return a descriptive error: `fmt.Errorf("tag: expected string or []string")`.

Change `PetSnippet.Tag` from `[]string` to `StringSlice`.

Update the one place `snippet.Tag` is used (line ~68): `Tags: snippet.Tag` — since `StringSlice` is `[]string` underneath, cast it: `Tags: []string(snippet.Tag)`.

The go-toml v2 package (`github.com/pelletier/go-toml/v2`) respects an `UnmarshalTOML(func(any) error) error` method signature. Do NOT use the older v1 interface (`UnmarshalTOML(*toml.Tree) error`).

Do not change any other logic in the file.
  </action>
  <verify>go test ./internal/importer/... -run TestPetImport -v</verify>
  <done>All existing TestPetImport_* tests still pass; no compile errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add bare-string tag regression test</name>
  <files>internal/importer/importer_test.go</files>
  <action>
Add a new test `TestPetImport_BareStringTag` immediately after the existing `TestPetImport_TagsCopied` test (around line 189).

The test input TOML must use a bare string for tag:

```toml
[[snippets]]
  description = "K8s snippet"
  command = "kubectl get pods"
  tag = "k8s"
  output = ""
```

Assert:
- `err` is nil
- `result.Workflows` has length 1
- `result.Workflows[0].Tags` equals `[]string{"k8s"}`

Also add a second test `TestPetImport_BareStringTagMultiple` — NOT needed (bare string by definition is one tag). Only the single bare-string case.

Do not modify any existing tests.
  </action>
  <verify>go test ./internal/importer/... -run TestPetImport_BareStringTag -v</verify>
  <done>TestPetImport_BareStringTag passes; tags are `["k8s"]` not an error.</done>
</task>

</tasks>

<verification>
Run the full importer test suite:

```
go test ./internal/importer/... -v
```

Expected: all tests pass including the new `TestPetImport_BareStringTag`.

Manual smoke test (optional):
```bash
cat > /tmp/pet-bare-tag.toml << 'EOF'
[[snippets]]
  description = "K8s get pods"
  command = "kubectl get pods -n <namespace=default>"
  tag = "k8s"
  output = ""
EOF
go run ./cmd/wf import pet /tmp/pet-bare-tag.toml
```
Expected: preview table shown, no parse error, workflow saved with tag `k8s`.
</verification>

<success_criteria>
- `go test ./internal/importer/... -v` exits 0 with all tests passing
- `TestPetImport_BareStringTag` exists and passes
- All pre-existing `TestPetImport_*` tests still pass (no regressions)
- `internal/importer/pet.go` compiles cleanly (`go build ./...`)
- A Pet TOML file with `tag = "k8s"` (bare string) is parsed without error
- A Pet TOML file with `tag = ["k8s", "deploy"]` (array) still works
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-07-SUMMARY.md` following the standard summary template.
</output>
