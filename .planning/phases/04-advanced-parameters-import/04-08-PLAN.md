---
phase: 04-advanced-parameters-import
plan: "08"
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/shell/zsh.go
  - internal/shell/bash.go
  - internal/shell/fish.go
  - cmd/wf/register.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "wf register (no-arg) reads the most recent command from the current shell session, not a stale prior session"
    - "When the sidecar file is absent (shell integration not sourced), wf register emits a clear warning explaining the history-flush limitation before proceeding"
    - "Shell integration scripts (zsh/bash/fish) write the previous command to ~/.local/share/wf/last_cmd via precmd/PROMPT_COMMAND before each prompt"
    - "go build ./... succeeds with no compile errors"
  artifacts:
    - path: "internal/shell/zsh.go"
      provides: "precmd hook that writes previous command to sidecar file"
      contains: "_wf_precmd"
    - path: "internal/shell/bash.go"
      provides: "PROMPT_COMMAND hook that writes previous command to sidecar file"
      contains: "_wf_precmd"
    - path: "internal/shell/fish.go"
      provides: "fish_postexec event hook that writes previous command to sidecar file"
      contains: "_wf_postexec"
    - path: "cmd/wf/register.go"
      provides: "lastFromHistory reads sidecar file first, falls back to $HISTFILE with warning"
      contains: "last_cmd"
  key_links:
    - from: "internal/shell/zsh.go"
      to: "~/.local/share/wf/last_cmd"
      via: "precmd hook: echo $history[1] > sidecar"
      pattern: "_wf_precmd"
    - from: "cmd/wf/register.go"
      to: "~/.local/share/wf/last_cmd"
      via: "os.ReadFile sidecar before history.NewReader()"
      pattern: "last_cmd"
---

<objective>
Fix `wf register` (no-arg mode) so it reliably captures the most recent command from the current shell session by using a sidecar file written by shell hooks, with a clear warning fallback when the integration is not active.

Purpose: Shells only flush history to disk on session exit — `wf register` was reading `$HISTFILE` which only contained commands from prior sessions, causing it to capture stale commands. The fix uses the shell's own pre-prompt hooks (which fire in the current session) to write the last command to a known sidecar path that `register.go` can read immediately.
Output: Updated shell scripts for zsh/bash/fish that maintain `~/.local/share/wf/last_cmd`, and updated `register.go` that reads the sidecar first.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-advanced-parameters-import/04-UAT.md

@internal/shell/zsh.go
@internal/shell/bash.go
@internal/shell/fish.go
@cmd/wf/register.go
@internal/history/detect.go
@internal/history/history.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add last-command sidecar hooks to shell integration scripts</name>
  <files>
    internal/shell/zsh.go
    internal/shell/bash.go
    internal/shell/fish.go
  </files>
  <action>
The sidecar file path is: `$HOME/.local/share/wf/last_cmd`

Respect XDG: use `${XDG_DATA_HOME:-$HOME/.local/share}/wf/last_cmd`.

**zsh (`internal/shell/zsh.go` — `ZshScript` constant):**

Add a `_wf_precmd` function and register it with `add-zsh-hook precmd`. The function writes `$history[1]` (the most recently executed command) to the sidecar file. `$history[1]` in zsh always refers to the last executed command from the current session's in-memory history, regardless of whether `$HISTFILE` has been flushed.

```zsh
_wf_precmd() {
  local _wf_dir="${XDG_DATA_HOME:-$HOME/.local/share}/wf"
  [[ -d "$_wf_dir" ]] || mkdir -p "$_wf_dir"
  print -r -- "$history[1]" > "$_wf_dir/last_cmd"
}
autoload -Uz add-zsh-hook
add-zsh-hook precmd _wf_precmd
```

Append this block at the end of `ZshScript`, after the existing `bindkey` lines.

**bash (`internal/shell/bash.go` — `BashScript` constant):**

Add a `_wf_precmd` function and prepend it to `PROMPT_COMMAND`. Use `history 1` to retrieve the last command (this reads bash's in-memory history). Strip the leading history number and whitespace.

```bash
_wf_precmd() {
  local _wf_dir="${XDG_DATA_HOME:-$HOME/.local/share}/wf"
  [[ -d "$_wf_dir" ]] || mkdir -p "$_wf_dir"
  local _last
  _last=$(HISTTIMEFORMAT='' history 1 | sed 's/^[ ]*[0-9]*[ ]*//')
  [[ -n "$_last" ]] && printf '%s' "$_last" > "$_wf_dir/last_cmd"
}
PROMPT_COMMAND="_wf_precmd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
```

Append this block at the end of `BashScript`, after the existing `bind` lines.

**fish (`internal/shell/fish.go` — `FishScript` constant):**

Fish provides the `fish_postexec` event, fired after each command completes, with `$argv[1]` being the command string just executed.

```fish
function _wf_postexec --on-event fish_postexec
  set -l _wf_dir (test -n "$XDG_DATA_HOME" && echo "$XDG_DATA_HOME" || echo "$HOME/.local/share")"/wf"
  mkdir -p "$_wf_dir"
  echo $argv[1] > "$_wf_dir/last_cmd"
end
```

Append this block at the end of `FishScript`, after the existing `bind` lines.

**Important:** The hooks must be appended AFTER the picker bindings. The sidecar directory is created on first use (no installer step needed).
  </action>
  <verify>go build ./... 2>&1 | head -20</verify>
  <done>All three shell script constants compile cleanly; no syntax errors in Go string literals. Each script contains the hook that writes to the sidecar file.</done>
</task>

<task type="auto">
  <name>Task 2: Update register.go to read sidecar first, warn on fallback</name>
  <files>cmd/wf/register.go</files>
  <action>
Modify `lastFromHistory()` in `cmd/wf/register.go` to implement the following priority order:

**Priority 1 — Sidecar file (most reliable, current-session):**
Compute the sidecar path:
```go
dataHome := os.Getenv("XDG_DATA_HOME")
if dataHome == "" {
    home, _ := os.UserHomeDir()
    dataHome = filepath.Join(home, ".local", "share")
}
sidecarPath := filepath.Join(dataHome, "wf", "last_cmd")
```
Attempt `os.ReadFile(sidecarPath)`. If it succeeds and the trimmed content is non-empty, return it immediately (no warning).

**Priority 2 — $HISTFILE fallback with warning:**
If the sidecar file is missing or empty, fall through to the existing `history.NewReader()` + `reader.Last()` call. Before returning the result, print a warning to stderr:

```
Warning: shell integration not active — reading $HISTFILE which may not contain your most recent command.
Tip: run 'eval "$(wf init zsh)"' (or bash/fish) in your shell config to enable accurate history capture.
```

Use `fmt.Fprintln(os.Stderr, ...)` for the warning so it doesn't pollute the captured command output.

**Imports to add:** `"os"` is already imported; add `"path/filepath"` to the import block if not already present.

Do NOT change the `pickFromHistory` function or any other function. Only modify `lastFromHistory`.

The function signature stays: `func lastFromHistory() (string, error)`.
  </action>
  <verify>go build ./cmd/wf/ && echo "build ok"</verify>
  <done>
    - `go build ./cmd/wf/` exits 0.
    - Code review: `lastFromHistory` reads sidecar before calling `history.NewReader()`.
    - Warning message printed to stderr (not stdout) when falling back to $HISTFILE.
    - `filepath` imported if needed.
  </done>
</task>

</tasks>

<verification>
**Build check:**
```bash
go build ./...
```
Expected: exits 0, no errors.

**Sidecar read logic (unit-level manual check):**
```bash
# Simulate the sidecar being present
mkdir -p ~/.local/share/wf
echo "echo hello world" > ~/.local/share/wf/last_cmd

# Run register (Ctrl+C after confirming it picked up the right command)
go run ./cmd/wf register
```
Expected first line of output: `Captured: echo hello world`

**Warning path (manual check):**
```bash
# Remove sidecar to force $HISTFILE fallback
rm -f ~/.local/share/wf/last_cmd
go run ./cmd/wf register
```
Expected: warning printed to stderr mentioning "shell integration not active", then falls back to $HISTFILE.

**Shell hook syntax check (zsh):**
```bash
# Source the generated script in a zsh subprocess and verify no errors
go run ./cmd/wf init zsh | zsh -n
```
Expected: exits 0 (no syntax errors).

**Shell hook syntax check (bash):**
```bash
go run ./cmd/wf init bash | bash -n
```
Expected: exits 0.
</verification>

<success_criteria>
- `go build ./...` exits 0
- `ZshScript` in `internal/shell/zsh.go` contains `_wf_precmd` with `add-zsh-hook precmd` that writes `$history[1]` to the sidecar
- `BashScript` in `internal/shell/bash.go` contains `_wf_precmd` prepended to `PROMPT_COMMAND` that writes `history 1` output to the sidecar
- `FishScript` in `internal/shell/fish.go` contains `_wf_postexec --on-event fish_postexec` that writes `$argv[1]` to the sidecar
- `lastFromHistory()` in `cmd/wf/register.go` reads `~/.local/share/wf/last_cmd` (XDG-aware) before falling back to `$HISTFILE`
- When sidecar is present and non-empty, `wf register` captures the correct current-session command with no warning
- When sidecar is absent, `wf register` falls back to `$HISTFILE` and prints a clear warning to stderr explaining the limitation and how to fix it
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-08-SUMMARY.md` following the standard summary template.
</output>
