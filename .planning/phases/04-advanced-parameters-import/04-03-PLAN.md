---
phase: 04-advanced-parameters-import
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/importer/importer.go
  - internal/importer/pet.go
  - internal/importer/warp.go
  - internal/importer/paramconv.go
  - internal/importer/importer_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Pet TOML snippets are converted to wf Workflow structs with correct field mapping"
    - "Pet parameter syntax (<param> and <param=default>) is converted to wf syntax ({{param}} and {{param:default}})"
    - "Warp YAML workflows are converted to wf Workflow structs with correct field mapping"
    - "Unmappable fields are preserved as warnings (Pet: output; Warp: source_url, author, author_url, shells)"
    - "Workflow names are auto-generated from Pet descriptions via slugify"
    - "Warp arguments map directly to wf Args with name, description, and default"
  artifacts:
    - path: "internal/importer/importer.go"
      provides: "ImportResult type with Workflows, Warnings, Errors; Importer interface"
      exports: ["ImportResult", "Importer"]
    - path: "internal/importer/pet.go"
      provides: "Pet TOML → Workflow converter"
      contains: "PetImporter"
    - path: "internal/importer/warp.go"
      provides: "Warp YAML → Workflow converter"
      contains: "WarpImporter"
    - path: "internal/importer/paramconv.go"
      provides: "Pet parameter syntax translation (<param=default> → {{param:default}})"
      contains: "convertPetParam"
    - path: "internal/importer/importer_test.go"
      provides: "Tests for both importers and parameter conversion"
      min_lines: 150
  key_links:
    - from: "internal/importer/pet.go"
      to: "internal/importer/paramconv.go"
      via: "Pet importer calls convertPetParam for command translation"
      pattern: "convertPetParam"
    - from: "internal/importer/pet.go"
      to: "internal/store/workflow.go"
      via: "Produces []store.Workflow"
      pattern: "store\\.Workflow"
---

<objective>
Create the importer package with converters for Pet TOML and Warp YAML formats, including parameter syntax translation.

Purpose: Foundation for `wf import` — must correctly parse and convert external workflow formats.
Output: Tested importer package with Pet and Warp converters, parameter translation, and warning preservation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-parameters-import/04-RESEARCH.md
@internal/store/workflow.go
</context>

<feature>
  <name>Pet and Warp Import Converters</name>
  <files>internal/importer/importer.go, internal/importer/pet.go, internal/importer/warp.go, internal/importer/paramconv.go, internal/importer/importer_test.go, go.mod, go.sum</files>
  <behavior>
    ImportResult struct:
    - Workflows []store.Workflow — successfully converted workflows
    - Warnings []string — unmappable features preserved as notes (for YAML comments later)
    - Errors []error — parse failures for individual entries

    Importer interface:
    - Import(reader io.Reader) (*ImportResult, error)

    Pet parameter conversion test cases:
    - "<host>" → "{{host}}"
    - "<host=localhost>" → "{{host:localhost}}"
    - "<url=http://example.com>" → "{{url:http://example.com}}" (= in default value)
    - "no params here" → "no params here" (passthrough)
    - "<a> and <b=x>" → "{{a}} and {{b:x}}" (multiple params)

    Pet TOML import test cases:
    - Single snippet with all fields → Workflow with Name (slugified from description), Command (params converted), Description, Tags
    - Pet `output` field → Warning: "output: <value>" (preserved for YAML comment)
    - Multiple snippets → multiple Workflows
    - Empty command → Error entry, skip workflow
    - Description "Deploy to staging" → Name "deploy-to-staging" (slugified)
    - Tags ["k8s", "deploy"] → Tags ["k8s", "deploy"] (direct copy)

    Warp YAML import test cases:
    - Single workflow with arguments → Workflow with Name, Command, Description, Tags, Args (with Name, Description, Default)
    - Warp `source_url` field → Warning preserved
    - Warp `author` + `author_url` → Warnings preserved
    - Warp `shells` field → Warning preserved
    - Warp `default_value: ~` (YAML null) → Arg.Default="" (empty string)
    - Warp `{{arg}}` syntax → unchanged (same as wf syntax)
    - Multiple workflows → multiple Workflows

    Name slugification (for Pet):
    - "Deploy to staging environment" → "deploy-to-staging-environment"
    - "Show SSL cert" → "show-ssl-cert"
    - "My (special) workflow!" → "my-special-workflow"
    - "" → "unnamed"
  </behavior>
  <implementation>
    RED: Write all test cases first. Use embedded TOML/YAML string literals. Tests MUST fail.

    GREEN:
    1. `go get github.com/pelletier/go-toml/v2@latest`
    2. Create internal/importer/importer.go — ImportResult struct, Importer interface.
    3. Create internal/importer/paramconv.go — convertPetParam(command string) string using regex `<([^>=]+?)(?:=([^>]*[^\s>]))?\s*>`. Also slugifyName(description string) string reusing the same slug logic as store.Workflow.Filename() but without ".yaml".
    4. Create internal/importer/pet.go — PetImporter implementing Importer. Parse TOML with pelletier/go-toml/v2 into PetFile{Snippets []PetSnippet}. Convert each snippet: slugify description → Name, convertPetParam(command) → Command, copy description/tags, extract Args from converted command using template.ExtractParams. If `output` non-empty, add warning.
    5. Create internal/importer/warp.go — WarpImporter implementing Importer. Parse YAML with goccy/go-yaml into WarpWorkflow struct. Convert: direct copy name/command/description/tags, map arguments to Args. Preserve source_url/author/author_url/shells as warnings.
    6. Run tests — all MUST pass.

    REFACTOR: Ensure error messages are descriptive ("pet snippet #3: empty command field").

    IMPORTANT: Use the project's existing goccy/go-yaml for Warp YAML parsing (NOT gopkg.in/yaml.v3). Add pelletier/go-toml/v2 for Pet TOML only.
  </implementation>
</feature>

<verification>
```bash
go test ./internal/importer/ -v -count=1
go vet ./internal/importer/
go build ./cmd/wf/
```
</verification>

<success_criteria>
- Pet TOML → Workflow conversion works with all field mappings
- Pet parameter syntax (<param>, <param=default>) converted correctly
- Warp YAML → Workflow conversion works with all field mappings
- Unmappable fields produce warnings (not silently dropped)
- Name slugification produces clean, filesystem-safe names
- pelletier/go-toml/v2 added to go.mod
- `go build ./cmd/wf/` compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-parameters-import/04-03-SUMMARY.md`
</output>
