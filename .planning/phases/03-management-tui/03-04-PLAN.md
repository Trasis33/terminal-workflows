---
phase: 03-management-tui
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - internal/manage/dialog.go
  - internal/manage/settings.go
  - internal/manage/model.go
autonomous: true

must_haves:
  truths:
    - "User sees a delete confirmation dialog overlay before workflow is deleted"
    - "User can create, rename, and delete folders from the sidebar"
    - "User can move a workflow to a different folder via quick-move shortcut"
    - "User can open a settings view to preview and apply themes"
    - "Theme changes are previewed live and persisted to theme.yaml"
    - "Preset themes are selectable from the settings view"
  artifacts:
    - path: "internal/manage/dialog.go"
      provides: "Dialog overlays for delete confirm, folder create/rename, and move workflow"
      contains: "type DialogModel struct"
      min_lines: 80
    - path: "internal/manage/settings.go"
      provides: "Settings view for theme customization with live preview"
      contains: "type SettingsModel struct"
      min_lines: 80
  key_links:
    - from: "internal/manage/model.go"
      to: "internal/manage/dialog.go"
      via: "Root model renders dialog as overlay on active view"
      pattern: "m\\.dialog"
    - from: "internal/manage/model.go"
      to: "internal/manage/settings.go"
      via: "Root model routes viewSettings to SettingsModel"
      pattern: "m\\.settings"
    - from: "internal/manage/settings.go"
      to: "internal/manage/theme.go"
      via: "Settings view calls SaveTheme() to persist changes"
      pattern: "SaveTheme"
    - from: "internal/manage/dialog.go"
      to: "internal/store/store.go"
      via: "Delete confirmation triggers store.Delete()"
      pattern: "store\\.Delete"
---

<objective>
Build dialog overlays (delete confirmation, folder management, workflow move) and the settings view for theme customization. These are the interactive elements that complete the management TUI's feature set.

Purpose: Delete confirmation prevents accidental data loss (MTUI-02). Folder management enables organization directly from the sidebar (MTUI-03). Theme settings deliver in-TUI customization with live preview (MTUI-04).
Output: DialogModel for overlays, SettingsModel for theme editing, fully wired into root model.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-management-tui/03-RESEARCH.md
@.planning/phases/03-management-tui/03-01-SUMMARY.md
@.planning/phases/03-management-tui/03-02-SUMMARY.md

@internal/manage/theme.go
@internal/manage/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dialog overlays — delete confirm, folder ops, move workflow</name>
  <files>
    internal/manage/dialog.go
    internal/manage/model.go
  </files>
  <action>
**dialog.go — DialogModel:**

Enum `dialogType`: `dialogDeleteConfirm`, `dialogFolderCreate`, `dialogFolderRename`, `dialogFolderDelete`, `dialogMoveWorkflow`

Struct fields:
- `dialogType dialogType`
- `title string`
- `message string`
- `input textinput.Model` — for folder create/rename and move (text input)
- `hasInput bool` — whether this dialog has a text input field
- `options []string` — for move dialog: list of available folders
- `optionCursor int` — for move dialog: selected folder
- `workflow *store.Workflow` — the workflow being acted on (for delete/move)
- `folderPath string` — for folder rename: the original path
- `confirmed bool` — whether user confirmed
- `theme Theme`

**Constructors:**
- `NewDeleteDialog(wf store.Workflow, theme Theme) DialogModel` — shows "Delete '{name}'? This cannot be undone." with y/n prompt
- `NewFolderCreateDialog(theme Theme) DialogModel` — text input for new folder name
- `NewFolderRenameDialog(oldPath string, theme Theme) DialogModel` — text input pre-filled with old name
- `NewFolderDeleteDialog(folderPath string, theme Theme) DialogModel` — confirm "Delete folder '{path}'? Must be empty."
- `NewMoveDialog(wf store.Workflow, folders []string, theme Theme) DialogModel` — list of folders to move to

**Update:**
- Delete/FolderDelete confirm: "y"/"enter" confirms, "n"/"esc" cancels → returns `dialogResultMsg{dialogType, confirmed bool, data map[string]string}`
- FolderCreate/Rename: "enter" submits input value, "esc" cancels → returns `dialogResultMsg`
- Move: up/down to select folder, "enter" confirms, "esc" cancels → returns `dialogResultMsg`

**View:**
- Render dialog box centered using `lipgloss.Place()` with whitespace fill chars ("░" in color "236") as per research pattern
- Dialog box: `theme.Styles().DialogBox` with title + message + input (if applicable) + "[y/n]" or "[enter/esc]" hints
- For move dialog: render folder list with cursor

**Custom message types:**
- `dialogResultMsg{dialogType dialogType, confirmed bool, data map[string]string}` — carries result back to root model

**model.go updates:**
- Add `dialog *DialogModel` field (already scaffolded in 03-01 as dialogState — replace with proper DialogModel pointer)
- Handle `showDeleteDialogMsg`: create delete dialog, set `m.dialog`
- Handle `showFolderDialogMsg`: create appropriate folder dialog
- Handle `moveWorkflowMsg`: create move dialog with available folders
- Handle `dialogResultMsg`:
  - Delete confirmed: `tea.Cmd` → `store.Delete(wf.Name)` → `refreshWorkflowsMsg`
  - Folder create: `os.MkdirAll(configDir/workflows/folderPath)` → refresh
  - Folder rename: `os.Rename(old, new)` → refresh
  - Folder delete: `os.Remove(folderPath)` (only empty) → refresh
  - Move confirmed: save workflow with new folder prefix, delete old → refresh
  - Any cancel: `m.dialog = nil` (dismiss)
- In `Update()`: if `m.dialog != nil`, route messages to dialog FIRST (dialog gets priority)
- In `View()`: if `m.dialog != nil`, render dialog as overlay on top of current view using `renderOverlay(base, dialog)` method

**renderOverlay(background, dialog string) string:**
- Use `lipgloss.Place(m.width, m.height, lipgloss.Center, lipgloss.Center, dialog, lipgloss.WithWhitespaceChars("░"), lipgloss.WithWhitespaceForeground(lipgloss.Color("236")))` as per research
- Note: lipgloss.Place replaces background content, not truly overlaying. This is acceptable — the dialog fills the screen with the patterned background.

**Folder operations use os package directly** (not Store interface, since Store doesn't have folder CRUD). Wrap in tea.Cmd for non-blocking I/O per pitfall #3.
  </action>
  <verify>
`go build ./internal/manage/...` compiles.
`go test ./...` — all existing tests pass.
Verify dialog renders centered with border using a test that calls `dialog.View()` and checks output contains title string.
  </verify>
  <done>
Delete confirmation dialog shows workflow name with y/n prompt. Folder create/rename dialogs have text input. Move dialog shows folder list with cursor. All dialogs render as centered overlays. Dialog results handled by root model with appropriate Store operations and refresh. Dialog gets message priority when active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings view for theme customization</name>
  <files>
    internal/manage/settings.go
    internal/manage/model.go
  </files>
  <action>
**settings.go — SettingsModel:**

Struct fields:
- `theme Theme` — the theme being edited (copy of current theme, not reference)
- `originalTheme Theme` — for cancel/revert
- `presetNames []string` — from `PresetNames()`
- `cursor int` — selected setting field
- `section settingsSection` — enum: `sectionPresets`, `sectionColors`, `sectionBorders`, `sectionLayout`
- `editing bool` — whether actively editing a value
- `editInput textinput.Model` — for editing color values
- `configDir string` — for saving
- `width, height int`
- `dirty bool` — whether changes have been made

**Settings layout — vertical list of editable fields:**
```
Theme Settings

Presets
  ▸ Default    Dark    Light    Dracula    Nord

Colors
  Primary:     [49]
  Secondary:   [158]
  Tertiary:    [73]
  Text:        [250]
  Dim:         [242]
  Border:      [238]

Borders
  Style:       [rounded]

Layout
  Sidebar Width: [24]
  Show Preview:  [true]

[Save]  [Cancel]
```

**Update:**
- Up/Down: navigate fields
- Left/Right on presets row: cycle through presets, apply immediately (live preview — update m.theme and recompute styles)
- Enter on a color/value field: enter edit mode, show textinput
- Enter on edit mode: apply value, recompute styles (live preview)
- "s": save theme → `SaveTheme(configDir, theme)` via tea.Cmd → `themeSavedMsg{}` → switch to browse
- Esc: if editing, cancel edit. If not editing, discard changes (revert to originalTheme) → switch to browse
- Tab: cycle between sections

**View:**
- Render settings as a styled list with section headers
- Highlight current field with theme.Styles().Selected
- Show color preview swatches next to color values (render a block of "██" in that ANSI color)
- Bottom hints: "↑↓ navigate  enter edit  s save  esc back"

**Live preview:**
- When user changes a color or selects a preset, call `m.theme.computeStyles()` and the entire settings view re-renders with the new theme — this IS the preview (the settings view itself uses the theme being edited)

**model.go updates:**
- Add `settings SettingsModel` field to root Model
- Handle `switchToSettingsMsg`: create SettingsModel with copy of current theme
- Handle `themeSavedMsg`: update root model's theme to the saved theme, recompute all child styles
- In Update(): when state is viewSettings, route to `m.settings.Update(msg)`
- In View(): when state is viewSettings, return `m.settings.View()`
  </action>
  <verify>
`go build ./internal/manage/...` compiles.
`go test ./...` — all tests pass.
Verify preset cycling: apply PresetDark(), check theme.Colors.Primary != "49".
Verify save: SaveTheme + LoadTheme round-trip produces identical Theme.
  </verify>
  <done>
Settings view renders editable theme fields with live preview. Preset themes selectable with left/right arrows. Color fields editable with text input. Save persists to theme.yaml. Cancel reverts changes. Settings view uses its own theme for self-preview. Root model routes viewSettings state correctly.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/manage/...` — compiles
2. `go test ./...` — all tests pass
3. Delete dialog renders centered with workflow name visible
4. Folder create dialog accepts text input and creates directory
5. Move dialog lists available folders
6. Settings view shows all theme fields
7. Preset selection changes colors live
8. Theme save produces valid YAML file
</verification>

<success_criteria>
- Delete confirmation prevents accidental deletion (y/n required)
- Folder operations (create/rename/delete) work from dialog overlays
- Move workflow dialog shows folder picker and relocates workflow
- Settings view displays all Theme fields with live preview
- Preset themes apply instantly on selection
- Theme changes persist to ~/.config/wf/theme.yaml
- All dialogs dismiss cleanly on cancel (esc/n)
</success_criteria>

<output>
After completion, create `.planning/phases/03-management-tui/03-04-SUMMARY.md`
</output>
