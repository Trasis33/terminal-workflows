---
phase: 03-management-tui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/manage/browse.go
  - internal/manage/sidebar.go
  - internal/manage/model.go
autonomous: true

must_haves:
  truths:
    - "User sees a two-pane layout: sidebar on left, workflow list on right"
    - "User sees a preview pane at the bottom showing selected workflow details"
    - "User can navigate workflows with arrow keys / j/k"
    - "User can toggle sidebar between folder view and tag view with tab"
    - "User can fuzzy search within the TUI with / key"
    - "User sees hint bar at the bottom with available keybindings"
  artifacts:
    - path: "internal/manage/browse.go"
      provides: "BrowseModel with two-pane layout, workflow list, preview pane, fuzzy search"
      contains: "type BrowseModel struct"
      min_lines: 150
    - path: "internal/manage/sidebar.go"
      provides: "SidebarModel with folder tree and tag list, switchable views"
      contains: "type SidebarModel struct"
      min_lines: 80
  key_links:
    - from: "internal/manage/browse.go"
      to: "internal/manage/sidebar.go"
      via: "BrowseModel embeds SidebarModel"
      pattern: "sidebar.*SidebarModel"
    - from: "internal/manage/browse.go"
      to: "internal/picker/search.go"
      via: "Reuses ParseQuery and Search for fuzzy matching"
      pattern: "picker\\.Search|picker\\.ParseQuery"
    - from: "internal/manage/model.go"
      to: "internal/manage/browse.go"
      via: "Root model holds BrowseModel and routes viewBrowse messages"
      pattern: "browse.*BrowseModel"
---

<objective>
Build the browse view — the primary screen users see when launching `wf manage`. Two-pane layout with switchable sidebar (folders/tags), scrollable workflow list with fuzzy search, and a bottom preview pane showing full details of the selected workflow.

Purpose: This is the main navigation interface. Users spend most time here browsing, searching, and selecting workflows before acting on them (edit, delete, move).
Output: Working browse view rendered by the root model, with keyboard navigation, sidebar toggle, and fuzzy search.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-management-tui/03-RESEARCH.md
@.planning/phases/03-management-tui/03-01-SUMMARY.md

# Existing fuzzy search to reuse
@internal/picker/search.go
@internal/picker/model.go
@internal/store/store.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sidebar component (folder tree + tag list)</name>
  <files>
    internal/manage/sidebar.go
  </files>
  <action>
Create `SidebarModel` with two sub-views that persist simultaneously (pitfall #5 from research — never recreate on toggle):

**Struct fields:**
- `mode sidebarMode` — enum: `sidebarFolders`, `sidebarTags`
- `folders []string` — list of folder paths (relative to workflows dir)
- `tags []string` — deduplicated list of all tags across workflows
- `folderCursor int` — selected folder index (0 = "All Workflows" virtual root)
- `tagCursor int` — selected tag index (0 = "All Tags" virtual root)
- `width, height int` — dimensions allocated by parent
- `theme Theme` — reference for styling

**Folder view rendering:**
- First item: "All Workflows" (special — no filter applied)
- Then sorted folder names, indented by depth (use `strings.Count(folder, "/")` for depth)
- Selected folder highlighted with theme.Styles().Selected
- Empty state: just "All Workflows" if no folders exist
- Show workflow count per folder in dim text (optional, pass counts from parent)

**Tag view rendering:**
- First item: "All Tags" (special — no filter applied)
- Then sorted tag names
- Selected tag highlighted with theme.Styles().Selected
- Show workflow count per tag in dim text (optional)

**Update method:**
- Up/Down: move cursor within current mode's list
- Enter: return a `sidebarFilterMsg{filterType, filterValue}` (custom message)
- Does NOT handle tab toggle (parent handles that and calls `ToggleMode()`)

**Public methods:**
- `NewSidebarModel(folders []string, tags []string, theme Theme) SidebarModel`
- `ToggleMode()` — switches between folder/tag mode
- `SetDimensions(width, height int)`
- `SelectedFilter() (filterType string, filterValue string)` — returns current selection ("folder", "path") or ("tag", "tagname") or ("", "") for "all"
- `Update(msg tea.Msg) (SidebarModel, tea.Cmd)`
- `View() string` — renders current mode
- `UpdateData(folders []string, tags []string)` — refresh data without losing cursor position (clamp if needed)
  </action>
  <verify>
`go build ./internal/manage/...` compiles.
`go vet ./internal/manage/...` passes.
  </verify>
  <done>
SidebarModel renders folder tree and tag list with cursor navigation, toggles between modes without losing state, and emits filter messages on selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Browse view with list + preview + search + root model wiring</name>
  <files>
    internal/manage/browse.go
    internal/manage/model.go
  </files>
  <action>
**browse.go — BrowseModel:**

Struct fields:
- `sidebar SidebarModel`
- `workflows []store.Workflow` — full list (unfiltered)
- `filtered []store.Workflow` — currently visible after filter + search
- `cursor int` — selected index in filtered list
- `scrollOffset int` — for virtual scrolling when list exceeds height
- `searchInput textinput.Model` — fuzzy search input (hidden until "/" pressed)
- `searching bool` — whether search input is active
- `searchQuery string` — current search text
- `filterType string` — "folder", "tag", or "" (from sidebar)
- `filterValue string` — the folder path or tag name
- `width, height int`
- `theme Theme`
- `keys keyMap`

Constructor: `NewBrowseModel(workflows []store.Workflow, folders []string, tags []string, theme Theme, keys keyMap) BrowseModel`

**Filtering logic:**
1. Apply sidebar filter first (folder prefix match or tag contains)
2. Then apply fuzzy search via `picker.Search()` / `picker.ParseQuery()` — reuse existing search package
3. Store result in `m.filtered`

**View rendering (using lipgloss composition):**
Layout: `JoinVertical(Left, topPane, preview, hints)`
- `topPane` = `JoinHorizontal(Top, sidebar, list)`
- Sidebar: `m.sidebar.View()` wrapped in `theme.Styles().Sidebar.Width(sidebarWidth).Height(listHeight)`
- List: scrollable workflow rows. Each row shows: cursor marker (if selected), workflow name (bold if selected), description (dim, truncated), tags in brackets (teal). Use styles from theme. Handle scroll offset so cursor stays visible.
- Preview: `theme.Styles().Preview.Width(fullWidth)` showing selected workflow's full command, folder, tags, args. Use viewport for scrollable preview if command is long.
- Hints: context-sensitive keybinding hints. When searching: "esc cancel  enter confirm". When browsing: "n new  e edit  d delete  m move  / search  tab folders/tags  ? help  q quit"

**Update method:**
- When NOT searching:
  - Up/Down/j/k: move cursor, update preview
  - Enter: no-op in browse (or could expand preview)
  - "/": activate search mode — show search input, focus it
  - "tab": call `m.sidebar.ToggleMode()`, refilter
  - "n": emit `switchToCreateMsg{}`
  - "e": emit `switchToEditMsg{workflow: m.filtered[m.cursor]}`
  - "d": emit `showDeleteDialogMsg{workflow: m.filtered[m.cursor]}`
  - "m": emit `moveWorkflowMsg{workflow: m.filtered[m.cursor]}`
  - "ctrl+t": emit `switchToSettingsMsg{}`
  - "q"/"ctrl+c": `tea.Quit`
  - "?": toggle full help display
  - Route sidebar messages (when sidebar has focus — handle left/right or dedicated keys)
- When searching:
  - "esc": cancel search, clear input, refilter without search
  - "enter": confirm search, exit search mode but keep filter
  - Other keys: update textinput, rerun fuzzy search on filtered list
- Handle `sidebarFilterMsg`: update filterType/filterValue, refilter

**model.go updates:**
- Add `browse BrowseModel` field to root Model
- In `New()`: construct BrowseModel with workflows, extracted folders, extracted tags
- In `Update()`: when `m.state == viewBrowse`, route to `m.browse.Update(msg)`
- In `View()`: when `m.state == viewBrowse`, return `m.browse.View()`
- Handle `refreshWorkflowsMsg`: reload from store, update browse data
- Add helper: `extractFolders(workflows []store.Workflow) []string` — derive folder list from workflow names containing "/"
- Add helper: `extractTags(workflows []store.Workflow) []string` — deduplicate all tags across workflows, sorted
- Propagate `tea.WindowSizeMsg` to browse model's `SetDimensions()` and sidebar

Important: Sidebar filter and search are independent — sidebar filters by folder/tag, search further narrows within the filtered set. This mirrors the picker's @tag filter behavior.
  </action>
  <verify>
`go build ./internal/manage/...` compiles.
`go build ./cmd/wf/...` compiles (no import cycles).
`go test ./...` — all existing tests still pass.
Manually verify: temporarily add `fmt.Println(browse.View())` in a test to confirm layout structure renders without panics.
  </verify>
  <done>
Browse view renders two-pane layout with sidebar (folders/tags toggle), scrollable workflow list with cursor navigation, fuzzy search via "/" key, and preview pane showing selected workflow details. Root model routes viewBrowse state to BrowseModel.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/manage/...` — compiles
2. `go vet ./internal/manage/...` — clean
3. `go test ./...` — all tests pass
4. Browse view renders without panics for: empty workflow list, single workflow, 50+ workflows
5. Sidebar toggles between folder/tag views and preserves cursor state
6. Fuzzy search filters workflow list correctly
</verification>

<success_criteria>
- Two-pane browse layout renders: sidebar (24 chars wide) + workflow list + preview pane
- Sidebar toggles between folder tree and tag list with tab, state preserved
- Workflow list scrolls with cursor navigation (up/down/j/k)
- Fuzzy search activates with "/", filters in real-time, cancels with esc
- Preview pane shows full details of selected workflow
- Hint bar shows context-sensitive keybindings
- Root model routes viewBrowse messages to BrowseModel
</success_criteria>

<output>
After completion, create `.planning/phases/03-management-tui/03-02-SUMMARY.md`
</output>
