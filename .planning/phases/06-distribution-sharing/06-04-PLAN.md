---
phase: 06-distribution-sharing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/shell/powershell.go
  - cmd/wf/init_shell.go
  - cmd/wf/pick_unix.go
  - cmd/wf/pick_windows.go
  - cmd/wf/pick.go
autonomous: true

must_haves:
  truths:
    - "User can run `wf init powershell` and get a valid PSReadLine script"
    - "PowerShell script binds Ctrl+G to invoke wf pick and insert result"
    - "openTTY() uses /dev/tty on Unix and CONOUT$ on Windows via build tags"
    - "pick.go no longer contains platform-specific openTTY code"
    - "Project cross-compiles for windows/amd64 without errors"
  artifacts:
    - path: "internal/shell/powershell.go"
      provides: "PowerShellScript constant for PSReadLine integration"
      exports: ["PowerShellScript"]
    - path: "cmd/wf/init_shell.go"
      provides: "powershell case in init command"
      contains: "powershell"
    - path: "cmd/wf/pick_unix.go"
      provides: "openTTY() for Unix using /dev/tty"
      contains: "go:build !windows"
    - path: "cmd/wf/pick_windows.go"
      provides: "openTTY() for Windows using CONOUT$"
      contains: "go:build windows"
  key_links:
    - from: "cmd/wf/init_shell.go"
      to: "internal/shell/powershell.go"
      via: "shell.PowerShellScript constant"
      pattern: "shell\\.PowerShellScript"
    - from: "cmd/wf/pick.go"
      to: "cmd/wf/pick_unix.go"
      via: "openTTY() via build tags"
      pattern: "openTTY"
---

<objective>
Add PowerShell 7+ shell integration and Windows-specific build tags for terminal I/O, enabling full Windows support.

Purpose: Completes cross-platform support — PowerShell users get the same Ctrl+G keybinding experience as zsh/bash/fish, and the picker works correctly on Windows via CONOUT$ instead of /dev/tty.

Output: internal/shell/powershell.go (new), cmd/wf/pick_unix.go (new), cmd/wf/pick_windows.go (new), modified cmd/wf/init_shell.go, modified cmd/wf/pick.go
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-distribution-sharing/06-RESEARCH.md
@internal/shell/zsh.go
@cmd/wf/init_shell.go
@cmd/wf/pick.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: PowerShell integration script + init command update</name>
  <files>internal/shell/powershell.go, cmd/wf/init_shell.go</files>
  <action>
1. Create internal/shell/powershell.go with package `shell`:

Export a `PowerShellScript` constant string (matching the pattern of ZshScript, BashScript, FishScript):

```powershell
# wf shell integration for PowerShell 7+
# Usage: wf init powershell | Invoke-Expression
# Or add to $PROFILE: wf init powershell | Invoke-Expression

Set-PSReadLineKeyHandler -Chord 'Ctrl+g' -ScriptBlock {
    [Microsoft.PowerShell.PSConsoleReadLine]::RevertLine()
    $output = wf pick 2>$null
    if ($output) {
        [Microsoft.PowerShell.PSConsoleReadLine]::Insert($output)
    }
}
```

Note: `2>$null` suppresses stderr (TUI renders to CONOUT$ on Windows, but stderr may carry warnings). `RevertLine()` clears current input before inserting. No sidecar/last_cmd tracking for PowerShell in v1 (zsh/bash/fish precmd hooks are shell-specific).

2. Modify cmd/wf/init_shell.go:
   - Add `"powershell"` case to the switch: `fmt.Print(shell.PowerShellScript)`
   - Update ValidArgs to include "powershell": `ValidArgs: []string{"zsh", "bash", "fish", "powershell"}`
   - Update the Example string to include: `  wf init powershell | Invoke-Expression`
   - Update the error message: `"unsupported shell: %s. Supported: zsh, bash, fish, powershell"`
  </action>
  <verify>
  `go build ./internal/shell/... ./cmd/wf/...` compiles.
  `go run ./cmd/wf init powershell` outputs a valid PSReadLine script containing Set-PSReadLineKeyHandler.
  `go run ./cmd/wf init --help` lists powershell in examples.
  </verify>
  <done>
  `wf init powershell` outputs a PSReadLine script that binds Ctrl+G to wf pick with Insert() for prompt injection. Init command accepts "powershell" as valid argument.
  </done>
</task>

<task type="auto">
  <name>Task 2: Windows build tags for openTTY</name>
  <files>cmd/wf/pick_unix.go, cmd/wf/pick_windows.go, cmd/wf/pick.go</files>
  <action>
1. Create cmd/wf/pick_unix.go:
```go
//go:build !windows

package main

import "os"

func openTTY() (*os.File, error) {
    return os.OpenFile("/dev/tty", os.O_WRONLY, 0)
}
```

2. Create cmd/wf/pick_windows.go:
```go
//go:build windows

package main

import "os"

func openTTY() (*os.File, error) {
    return os.OpenFile("CONOUT$", os.O_WRONLY, 0)
}
```

3. Modify cmd/wf/pick.go:
   - Remove the existing `openTTY()` function (lines 17-19) and its doc comment (lines 13-16). This function is now provided by the platform-specific files.
   - Remove the `"os"` import if it's no longer needed in pick.go (it's still needed for os.Stderr and os.Stdout — check carefully before removing).
   - Keep everything else in pick.go unchanged.

4. Verify cross-compilation:
   - `GOOS=linux GOARCH=amd64 go build ./cmd/wf/...` — should use pick_unix.go
   - `GOOS=windows GOARCH=amd64 go build ./cmd/wf/...` — should use pick_windows.go
   - `GOOS=darwin GOARCH=arm64 go build ./cmd/wf/...` — should use pick_unix.go
  </action>
  <verify>
  `go build ./cmd/wf/...` compiles (native platform).
  `GOOS=windows GOARCH=amd64 go build ./cmd/wf/...` compiles without errors.
  `GOOS=linux GOARCH=amd64 go build ./cmd/wf/...` compiles without errors.
  Verify pick.go no longer contains openTTY function definition.
  </verify>
  <done>
  openTTY() is platform-specific: /dev/tty on Unix, CONOUT$ on Windows. Cross-compilation works for all three platforms. pick.go is clean of platform code.
  </done>
</task>

</tasks>

<verification>
```bash
go build ./cmd/wf/...
go vet ./cmd/wf/...
GOOS=windows GOARCH=amd64 go build ./cmd/wf/...
GOOS=linux GOARCH=amd64 go build ./cmd/wf/...
go run ./cmd/wf init powershell
go test ./...
```
</verification>

<success_criteria>
- `wf init powershell` outputs valid PSReadLine script with Ctrl+G binding
- openTTY uses build tags — /dev/tty on Unix, CONOUT$ on Windows
- Cross-compilation succeeds for darwin/arm64, linux/amd64, windows/amd64
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution-sharing/06-04-SUMMARY.md`
</output>
