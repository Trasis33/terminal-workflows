---
phase: 08-smart-defaults
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/wf/register.go
  - internal/register/detect_test.go
  - internal/picker/paramfill.go
  - internal/picker/styles.go
autonomous: true
requirements: [DFLT-01, DFLT-02]

must_haves:
  truths:
    - "User runs wf register, accepts parameterization of a detected value, and the saved YAML contains Args[].Default with the original value"
    - "User opens picker for a workflow with stored defaults, and text inputs are pre-filled with those defaults"
    - "Pre-filled default values appear visually distinct (dim/muted) from user-typed values (normal brightness)"
    - "User presses Enter on a pre-filled default to accept it without retyping"
    - "Inline template defaults (e.g. {{host:10.0.0.1}}) still take priority — register does not overwrite them"
  artifacts:
    - path: "cmd/wf/register.go"
      provides: "Default capture during register parameterization"
      contains: "s.Original"
    - path: "internal/picker/paramfill.go"
      provides: "Stored default merge and dim-style rendering"
      contains: "selected.Args"
  key_links:
    - from: "cmd/wf/register.go"
      to: "internal/template/parser.go"
      via: "{{param:original}} syntax parsed by ExtractParams"
      pattern: "s\\.ParamName.*s\\.Original"
    - from: "internal/picker/paramfill.go"
      to: "store.Arg.Default"
      via: "merge loop cross-referencing m.selected.Args"
      pattern: "selected\\.Args"
---

<objective>
Implement smart defaults: register captures detected values as parameter defaults, picker pre-fills stored defaults with visual distinction.

Purpose: Users never retype values they've already entered — wf register preserves originals and the picker pre-populates them.
Output: Modified register.go (default capture), modified paramfill.go (default merge + dim styling).
</objective>

<execution_context>
@/Users/fredriklanga/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/fredriklanga/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-smart-defaults/08-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From internal/store/workflow.go:
```go
type Workflow struct {
    Name        string   `yaml:"name"`
    Command     string   `yaml:"command"`
    Description string   `yaml:"description"`
    Tags        []string `yaml:"tags,omitempty"`
    Args        []Arg    `yaml:"args,omitempty"`
}

type Arg struct {
    Name        string   `yaml:"name"`
    Default     string   `yaml:"default,omitempty"`
    Description string   `yaml:"description,omitempty"`
    Type        string   `yaml:"type,omitempty"`
    Options     []string `yaml:"options,omitempty"`
    DynamicCmd  string   `yaml:"dynamic_cmd,omitempty"`
}
```

From internal/register/detect.go:
```go
type Suggestion struct {
    Original  string // The matched text (e.g., "10.0.0.1")
    ParamName string // Suggested parameter name (e.g., "host")
    Start     int    // Start position in command string
    End       int    // End position in command string
}
```

From internal/template/parser.go:
```go
type Param struct {
    Name       string
    Type       ParamType
    Default    string
    Options    []string
    DynamicCmd string
}

func ExtractParams(command string) []Param  // Parses {{name:default}} syntax
func parseInner(s string) Param              // Colon splits on first colon: name=left, default=right
```

From internal/picker/paramfill.go:
```go
func initParamFill(m *Model)  // Calls template.ExtractParams(m.selected.Command), ignores m.selected.Args
// Line 69-71: text params with defaults are pre-filled via ti.SetValue(p.Default)
```

From internal/picker/styles.go:
```go
var dimStyle = lipgloss.NewStyle().Foreground(lipgloss.Color("242"))  // Used for secondary text
var normalStyle = lipgloss.NewStyle().Foreground(lipgloss.Color("250"))  // Default text
```

From internal/picker/model.go:
```go
type Model struct {
    // ...
    selected    store.Workflow  // The selected workflow — has .Args with stored defaults
    params      []template.Param
    paramInputs []textinput.Model
    // ...
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture detected values as defaults in wf register</name>
  <files>cmd/wf/register.go, internal/register/detect_test.go</files>
  <action>
  In `cmd/wf/register.go`, modify `applyDetectedParams()` at line 230 to embed the original detected value as the default in the template syntax:

  Change:
  ```go
  replacement := "{{" + s.ParamName + "}}"
  ```
  To:
  ```go
  replacement := "{{" + s.ParamName + ":" + s.Original + "}}"
  ```

  This single change makes `wf register` produce `{{host:10.0.0.1}}` instead of `{{host}}` when the user accepts a detected IP. The existing `template.ExtractParams` already parses `{{name:default}}` syntax correctly (splitting on first colon), so the default flows through to `Arg.Default` automatically via the existing code at lines 89-95.

  **Edge case — colons in originals:** Values like `http://localhost:8080` will produce `{{url:http://localhost:8080}}`. The parser splits on the FIRST colon only, yielding name=`url`, default=`http://localhost:8080`. This is already tested and works.

  **Inline default priority (CONTEXT.md locked decision):** If the user manually writes `{{host:10.0.0.1}}` in their template, that inline default is immutable. The register flow only applies to auto-detected values that get parameterized — it never touches existing template syntax. No special handling needed since register replaces literal values, not existing `{{...}}` patterns.

  Also update the display message at line 181 to show the default being captured:
  ```go
  fmt.Printf("  %d. %s → {{%s}} (default: %s)\n", i+1, s.Original, s.ParamName, s.Original)
  ```

  **Testing:** Add a test in `internal/register/detect_test.go` (or create `cmd/wf/register_test.go` if cleaner) that verifies a command with detected params produces the `:original` syntax after substitution. The substitution logic is in `applyDetectedParams` which is in `cmd/wf/` — since it reads from stdin, the simplest approach is to verify via the existing `DetectParams` integration by checking the Suggestion.Original field is available. The actual substitution test can be an inline test within register.go or a manual verification.

  Alternatively, extract the substitution logic into a testable function:
  ```go
  func substituteParams(command string, suggestions []register.Suggestion, selected []int) string
  ```
  Move the reverse-order substitution loop (lines 216-232) into this function. Test it directly with table-driven tests:
  - Input: `"ssh root@10.0.0.1"`, suggestions for `10.0.0.1`, selected all → `"ssh root@{{host:10.0.0.1}}"`
  - Input: `"curl http://api.example.com:8080/v1"`, suggestions for URL → `"curl {{url:http://api.example.com:8080/v1}}"`
  - Input: command with multiple params → all get `:original` suffix
  </action>
  <verify>
    <automated>cd /Users/fredriklanga/Documents/Projects2026/terminal-workflows && go build ./cmd/wf/ && go test ./cmd/wf/ ./internal/register/ -v -run "Test.*ubstit|Test.*efault" -count=1</automated>
  </verify>
  <done>
  - `applyDetectedParams` produces `{{paramName:originalValue}}` syntax
  - Existing `ExtractParams` correctly parses the colon-default syntax (already works)
  - The display message shows the default being captured
  - `substituteParams` function is tested with table-driven tests covering IPs, URLs, and multi-param cases
  - `go build ./cmd/wf/` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Pre-fill stored defaults in picker and add visual distinction</name>
  <files>internal/picker/paramfill.go, internal/picker/styles.go</files>
  <action>
  **Problem:** `initParamFill()` in `paramfill.go` extracts params from `m.selected.Command` via `template.ExtractParams()`. If a default exists in the command template syntax (e.g., `{{host:10.0.0.1}}`), it's pre-filled. But if the default is ONLY in `store.Arg.Default` (not in the template syntax), it's ignored. This is the key gap for DFLT-02.

  **Fix 1 — Merge stored defaults into params:**

  After line 27 (`m.params = template.ExtractParams(m.selected.Command)`), add a merge loop:

  ```go
  // Merge stored Arg defaults into extracted params.
  // Stored defaults supplement template-inline defaults (inline takes priority).
  for i, p := range m.params {
      if p.Default == "" {
          for _, arg := range m.selected.Args {
              if arg.Name == p.Name && arg.Default != "" {
                  m.params[i].Default = arg.Default
                  break
              }
          }
      }
  }
  ```

  This goes BEFORE the `for i, p := range m.params` loop that creates textinputs (line 36). The existing `ti.SetValue(p.Default)` at line 70 then picks up the merged default automatically.

  **Why this works:** Inline template defaults (parsed by ExtractParams) already populate `p.Default`. This merge only fills in empty defaults from stored Args. Per CONTEXT.md: "Inline template defaults are the author's intent and are immutable — they take priority over captured values."

  **Fix 2 — Visual distinction for pre-filled defaults:**

  Per CONTEXT.md locked decision: "Pre-filled defaults shown in dim/muted color, user-typed values in normal/bright color" and "cursor placed at end of default value for in-place editing (not replace-on-first-keystroke)".

  In `internal/picker/styles.go`, add a new style for default text in the textinput:
  ```go
  // defaultTextStyle renders pre-filled default values in dim color.
  var defaultTextStyle = lipgloss.NewStyle().Foreground(lipgloss.Color("245"))
  ```

  In `initParamFill()`, for text params with defaults, configure the textinput to show the default dimly:
  - Use `ti.TextStyle` to set dim styling when the value equals the default
  - Use `ti.Cursor.Style` to keep cursor visible
  - Position cursor at end: `ti.CursorEnd()` after `ti.SetValue(p.Default)`

  The Bubble Tea `textinput.Model` has a `TextStyle` field (lipgloss.Style) that controls rendered text color. Set it to dim initially:
  ```go
  if p.Default != "" {
      ti.SetValue(p.Default)
      ti.TextStyle = defaultTextStyle
      ti.CursorEnd()
  }
  ```

  **Fix 3 — Switch to normal style on user edit:**

  In `updateParamFill()`, in the `default:` case (lines 218-226) where text input handles keystrokes, reset the text style to normal when the user types:
  ```go
  case "backspace", "delete":
      // Let textinput handle, then check if value changed from default
      var cmd tea.Cmd
      m.paramInputs[m.focusedParam], cmd = m.paramInputs[m.focusedParam].Update(msg)
      m.paramInputs[m.focusedParam].TextStyle = lipgloss.NewStyle()
      return m, cmd
  ```

  For the general `default:` text input handler:
  ```go
  default:
      if m.isListParam(m.focusedParam) {
          return m, nil
      }
      var cmd tea.Cmd
      m.paramInputs[m.focusedParam], cmd = m.paramInputs[m.focusedParam].Update(msg)
      // Switch to normal style once user edits (any keystroke changes the default state)
      m.paramInputs[m.focusedParam].TextStyle = lipgloss.NewStyle()
      return m, cmd
  ```

  **IMPORTANT:** The `(default)` annotation at lines 312 and 361 already works via `p.Default != "" && value == p.Default`. This will continue to show "(default)" when the pre-filled value hasn't been changed, and hide it when the user types something different. No changes needed there.

  **Fix 4 — Always show param fill screen (CONTEXT.md locked decision):**
  The CONTEXT.md says: "Always show the param fill screen even when all params have defaults — user presses Enter through each to confirm or modify." Check the transition logic in `model.go` — if there's a fast path that skips param fill when all params have defaults, remove it. Looking at the current code, `updateSearch` transitions to `StateParamFill` when params exist (line in model.go that checks `len(m.params) > 0`). If all params have defaults, they'll all be pre-filled but the screen still shows. This should already work correctly — verify by checking the search→paramfill transition code.
  </action>
  <verify>
    <automated>cd /Users/fredriklanga/Documents/Projects2026/terminal-workflows && go build ./cmd/wf/ && go vet ./internal/picker/...</automated>
  </verify>
  <done>
  - Picker paramfill merges stored `Arg.Default` values for params that have no inline template default
  - Pre-filled defaults appear in dim/muted color (Color 245)
  - User-typed text appears in normal color (default style)
  - Cursor is positioned at end of pre-filled default for in-place editing
  - "(default)" annotation still shows correctly next to unmodified defaults
  - Param fill screen always shows even when all params have defaults (no auto-skip)
  - `go build` and `go vet` pass
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/wf/` compiles successfully
2. `go test ./... -count=1` — all existing tests pass (no regressions)
3. `go vet ./...` — no lint issues
4. Manual flow test (executor should describe but not block on):
   - `wf register 'ssh root@10.0.0.1 -p 2222'` → accept both detections → check saved YAML has `default: 10.0.0.1` and `default: 2222`
   - Run the saved workflow via picker → text inputs pre-filled with `10.0.0.1` and `2222` in dim color
   - Press Enter through all params → command rendered with defaults
   - Edit one param → text switches to bright, "(default)" annotation disappears
</verification>

<success_criteria>
- wf register embeds detected original values as `{{param:original}}` defaults (DFLT-01)
- Picker param fill pre-populates defaults from stored Args with dim visual distinction (DFLT-02)
- All existing tests pass — no regressions in template parsing, register detection, or picker search
- go build, go test, go vet all clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-smart-defaults/08-01-SUMMARY.md`
</output>
