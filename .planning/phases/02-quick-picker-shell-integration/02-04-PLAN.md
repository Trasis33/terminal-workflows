---
phase: 02-quick-picker-shell-integration
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - cmd/wf/pick.go
  - cmd/wf/root.go
  - internal/picker/model.go
autonomous: false

must_haves:
  truths:
    - "wf pick launches the Bubble Tea picker on stderr, outputs selected command on stdout"
    - "wf pick with no workflows shows empty state and exits cleanly"
    - "wf pick uses tea.WithAltScreen and tea.WithOutput(os.Stderr)"
    - "Picker exits with status 0 on selection and status 0 on cancel (no output)"
    - "Binary cross-compiles for macOS, Linux, and Windows"
    - "User can copy workflow command to clipboard instead of pasting to prompt"
  artifacts:
    - path: "cmd/wf/pick.go"
      provides: "wf pick Cobra command wiring picker model to tea.Program"
      exports: ["pickCmd"]
    - path: "cmd/wf/root.go"
      provides: "Updated root with pickCmd registered"
      contains: "pickCmd"
  key_links:
    - from: "cmd/wf/pick.go"
      to: "internal/picker/model.go"
      via: "Creates picker.New(workflows), runs tea.NewProgram"
      pattern: "picker\\.New"
    - from: "cmd/wf/pick.go"
      to: "internal/store/store.go"
      via: "Loads workflows via store.List()"
      pattern: "getStore\\(\\)\\.List\\(\\)"
    - from: "cmd/wf/pick.go"
      to: "os.Stdout"
      via: "Writes final Result to stdout for shell capture"
      pattern: "fmt\\.Fprintln\\(os\\.Stdout"
    - from: "cmd/wf/pick.go"
      to: "atotto/clipboard"
      via: "Copies to clipboard when --copy flag set or Ctrl+Y pressed"
      pattern: "clipboard\\.WriteAll"
---

<objective>
Wire the picker TUI to the CLI via `wf pick`, add clipboard support (PICK-04), verify cross-compilation (SHEL-05), and do a human verification of the full end-to-end flow.

Purpose: This is the final integration plan — connecting the picker model to the CLI entry point, adding the clipboard alternative path, and verifying the full user journey from `wf pick` through selection to prompt paste.
Output: `cmd/wf/pick.go` with Cobra command, updated `cmd/wf/root.go`, cross-compile verification.
</objective>

<execution_context>
@~/.config/opencode/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quick-picker-shell-integration/02-RESEARCH.md
@.planning/phases/02-quick-picker-shell-integration/02-02-SUMMARY.md
@.planning/phases/02-quick-picker-shell-integration/02-03-SUMMARY.md
@cmd/wf/root.go
@internal/picker/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: wf pick command with clipboard support</name>
  <files>cmd/wf/pick.go, cmd/wf/root.go</files>
  <action>
    Create `cmd/wf/pick.go`:
    - Cobra command: `pickCmd` with Use: "pick", Short: "Launch fuzzy workflow picker"
    - Flag: `--copy` / `-c` (bool) — copy to clipboard instead of printing to stdout
    - RunE function:
      1. Load workflows: `s := getStore(); workflows, err := s.List()`
      2. Create picker model: `m := picker.New(workflows)`
      3. Create tea.Program with options:
         - `tea.WithAltScreen()` — clean overlay
         - `tea.WithOutput(os.Stderr)` — TUI renders to stderr (Pitfall 1)
      4. Run: `final, err := p.Run()`
      5. Extract result: `fm := final.(picker.Model)`
      6. If fm.Result is empty (user cancelled): exit cleanly (return nil, no output)
      7. If --copy flag: call `clipboard.WriteAll(fm.Result)`, print "Copied to clipboard" to stderr
      8. Else: `fmt.Fprintln(os.Stdout, fm.Result)` — shell function captures this

    Also add clipboard support inside the picker itself:
    - In the picker model, handle Ctrl+Y in StateSearch (when a workflow is highlighted): copy the workflow's command to clipboard, show brief flash message, don't quit. This gives users an alternative to the --copy flag.
    - The --copy flag is for scripting; Ctrl+Y is for interactive use.

    Update `cmd/wf/root.go`:
    - Add `rootCmd.AddCommand(pickCmd)` in init()

    Critical implementation details (from RESEARCH.md):
    - Do NOT use tea.WithInput — default stdin is correct
    - tea.WithOutput(os.Stderr) is MANDATORY — without it, TUI renders to stdout which the shell function captures as the "result"
    - Use `p.Run()` not `p.Start()` (Bubble Tea v2)
    - PICK-02 PERFORMANCE: Load workflows synchronously BEFORE creating tea.Program — do NOT use a background tea.Cmd for the initial list load (Pitfall 6 in RESEARCH.md). The store.List() call must complete before picker.New() is called.
  </action>
  <verify>
    `go build ./cmd/wf/` compiles.
    `./wf pick --help` shows usage with --copy flag.
    `go vet ./cmd/wf/` passes.
    Startup timing: `time (echo -e '\033' | ./wf pick 2>/dev/null)` should complete in under 200ms wall clock.
  </verify>
  <done>`wf pick` launches picker, outputs selected command to stdout. `wf pick --copy` copies to clipboard. Ctrl+Y copies highlighted workflow. pickCmd registered in root.</done>
</task>

<task type="auto">
  <name>Task 2: Cross-compilation verification</name>
  <files>(no files modified — verification only)</files>
  <action>
    Verify SHEL-05 (binary works standalone on macOS, Linux, and Windows) by cross-compiling:

    ```bash
    GOOS=darwin GOARCH=amd64 go build -o /dev/null ./cmd/wf/
    GOOS=darwin GOARCH=arm64 go build -o /dev/null ./cmd/wf/
    GOOS=linux GOARCH=amd64 go build -o /dev/null ./cmd/wf/
    GOOS=linux GOARCH=arm64 go build -o /dev/null ./cmd/wf/
    GOOS=windows GOARCH=amd64 go build -o /dev/null ./cmd/wf/
    ```

    If any fail, investigate CGo dependencies. atotto/clipboard should be pure Go on all platforms. If clipboard requires CGo on Linux (for X11), consider build tags to make clipboard optional.

    Also run the full test suite:
    ```bash
    go test ./... -race
    ```
  </action>
  <verify>
    All 5 cross-compilation commands succeed.
    `go test ./... -race` passes.
  </verify>
  <done>Binary cross-compiles for darwin/amd64, darwin/arm64, linux/amd64, linux/arm64, windows/amd64. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end picker verification</name>
  <what-built>Full wf pick workflow: fuzzy search, tag filter, parameter fill, paste-to-prompt via shell integration</what-built>
  <how-to-verify>
    1. Build: `go build -o wf ./cmd/wf/`

    2. Create test workflows:
       ```
       ./wf add --name "docker-build" --command "docker build -t {{image_name}} {{dockerfile_path:./Dockerfile}}" --desc "Build Docker image" --tags docker,build
       ./wf add --name "git-push" --command "git push {{remote:origin}} {{branch}}" --desc "Push to remote" --tags git
       ./wf add --name "echo-hello" --command "echo hello world" --desc "Simple echo" --tags test
       ```

    3. Test standalone picker:
       - Run `./wf pick 2>/dev/null` (redirects TUI to null, shows only output)
       - Verify: picker should appear (if terminal supports it), navigate with arrows, select with Enter

    4. Test fuzzy search:
       - Type "dock" — should match "docker-build"
       - Type "@docker" — should filter to docker-tagged workflows
       - Type "@docker build" — should filter by tag, then fuzzy match
       - Empty search should show all 3 workflows

    5. Test parameter fill:
       - Select "docker-build" — should show param fill with image_name (empty) and dockerfile_path (pre-filled "./Dockerfile")
       - Tab between params, fill image_name, press Enter
       - Verify output is the completed command

    6. Test zero-param workflow:
       - Select "echo-hello" — should paste instantly (no param fill step)

    7. Test clipboard:
       - Run `./wf pick --copy`, select a workflow
       - Verify command is in clipboard (paste somewhere to check)

    8. Test shell integration:
       - Run `eval "$(./wf init zsh)"` (or bash/fish as appropriate)
       - Press Ctrl+G — picker should appear
       - Select a workflow — command should appear on prompt line

    9. Test performance:
       - Picker should appear in under 100ms (subjective feel — it should feel instant)

    10. Test escape:
        - Press Esc at any point — picker should close, no output
  </how-to-verify>
  <resume-signal>Type "approved" if the full flow works, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
1. `go build -o wf ./cmd/wf/` — builds successfully
2. Cross-compilation succeeds for all 5 targets
3. `go test ./... -race` — all tests pass
4. Human verification of full end-to-end flow
</verification>

<success_criteria>
- `wf pick` launches picker, fuzzy search works, param fill works, outputs to stdout
- `wf pick --copy` copies to clipboard
- Cross-compilation succeeds for macOS, Linux, Windows
- Shell integration (wf init zsh/bash/fish) works with Ctrl+G keybinding
- All tests pass with race detector
- Human approves full end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/02-quick-picker-shell-integration/02-04-SUMMARY.md`
</output>
