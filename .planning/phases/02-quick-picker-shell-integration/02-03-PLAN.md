---
phase: 02-quick-picker-shell-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/shell/zsh.go
  - internal/shell/bash.go
  - internal/shell/fish.go
  - cmd/wf/init_shell.go
  - cmd/wf/root.go
autonomous: true

must_haves:
  truths:
    - "wf init zsh outputs a shell script that binds Ctrl+G to invoke wf pick"
    - "wf init bash outputs a shell script that binds Ctrl+G to invoke wf pick"
    - "wf init fish outputs a shell script that binds Ctrl+G to invoke wf pick"
    - "Shell scripts use fd swap (3>&1 1>&2 2>&3) for TUI/output separation"
    - "Shell scripts write selected command to LBUFFER/READLINE_LINE/commandline"
  artifacts:
    - path: "internal/shell/zsh.go"
      provides: "Zsh init script as Go string constant"
      contains: "LBUFFER"
    - path: "internal/shell/bash.go"
      provides: "Bash init script as Go string constant"
      contains: "READLINE_LINE"
    - path: "internal/shell/fish.go"
      provides: "Fish init script as Go string constant"
      contains: "commandline -r"
    - path: "cmd/wf/init_shell.go"
      provides: "wf init zsh|bash|fish Cobra command"
      exports: ["initCmd"]
  key_links:
    - from: "cmd/wf/init_shell.go"
      to: "internal/shell/*.go"
      via: "Prints shell script constant to stdout"
      pattern: "shell\\..*Script"
    - from: "internal/shell/zsh.go"
      to: "wf pick"
      via: "Shell script invokes wf pick binary"
      pattern: "wf pick"
---

<objective>
Create shell integration scripts for zsh, bash, and fish, plus the `wf init` CLI command that outputs them.

Purpose: Shell integration is how users bind a keybinding to invoke the picker. The `wf init zsh` command outputs a script that users source in their shell config. This is independent of the picker TUI (it just invokes the `wf pick` binary).
Output: `internal/shell/zsh.go`, `internal/shell/bash.go`, `internal/shell/fish.go`, `cmd/wf/init_shell.go`
</objective>

<execution_context>
@~/.config/opencode/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quick-picker-shell-integration/02-RESEARCH.md
@cmd/wf/root.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shell script constants</name>
  <files>internal/shell/zsh.go, internal/shell/bash.go, internal/shell/fish.go</files>
  <action>
    Create `internal/shell/` package with three files, each exporting a string constant containing the production-ready shell script.

    **internal/shell/zsh.go:**
    - package shell
    - const ZshScript = raw string literal containing the zsh integration script
    - Script content (from RESEARCH.md, verified from fzf/atuin source):
      - _wf_picker() function that runs `wf pick 3>&1 1>&2 2>&3`
      - Captures output, assigns to LBUFFER, clears RBUFFER
      - `zle reset-prompt`
      - Registers as ZLE widget: `zle -N _wf_picker`
      - Binds in all keymaps: `bindkey -M emacs '^G' _wf_picker`, `bindkey -M viins '^G' _wf_picker`, `bindkey -M vicmd '^G' _wf_picker`
      - Header comment: `# wf shell integration for zsh` and `# Usage: eval "$(wf init zsh)"  or  source <(wf init zsh)`

    **internal/shell/bash.go:**
    - const BashScript = raw string literal
    - _wf_picker() function that runs `wf pick 3>&1 1>&2 2>&3`
    - Captures output, assigns to READLINE_LINE, sets READLINE_POINT to string length
    - `bind -m emacs-standard -x '"\C-g": _wf_picker'`
    - `bind -m vi-insert -x '"\C-g": _wf_picker'`
    - Header comment with usage: `eval "$(wf init bash)"`

    **internal/shell/fish.go:**
    - const FishScript = raw string literal
    - function _wf_picker that runs `wf pick 3>&1 1>&2 2>&3 | string collect`
    - If non-empty: `commandline -r $output`
    - `commandline -f repaint`
    - `bind \cg _wf_picker`
    - `bind -M insert \cg _wf_picker`
    - Header comment with usage: `wf init fish | source`

    All scripts use Ctrl+G as the default keybinding. The RESEARCH.md analysis confirms this is the least conflicting option (only overrides readline's rarely-used "abort" in bash).
  </action>
  <verify>
    `go build ./internal/shell/` compiles.
    `go vet ./internal/shell/` passes.
  </verify>
  <done>Three shell script constants exist with correct LBUFFER/READLINE_LINE/commandline patterns, fd swap, and Ctrl+G binding.</done>
</task>

<task type="auto">
  <name>Task 2: wf init command</name>
  <files>cmd/wf/init_shell.go, cmd/wf/root.go</files>
  <action>
    Create `cmd/wf/init_shell.go`:
    - Cobra command: `initCmd` with Use: "init", Short: "Output shell integration script"
    - Takes exactly 1 argument: "zsh", "bash", or "fish"
    - ValidArgs: []string{"zsh", "bash", "fish"}
    - Args: cobra.ExactArgs(1)
    - RunE: switch on args[0], print the corresponding shell.ZshScript / shell.BashScript / shell.FishScript to stdout
    - If invalid shell name (shouldn't happen with ValidArgs, but defensive): return error "unsupported shell: %s. Supported: zsh, bash, fish"

    Update `cmd/wf/root.go`:
    - Add `rootCmd.AddCommand(initCmd)` in the init() function

    Note: Use the name `init_shell.go` (not `init.go`) to avoid confusion with Go's special `init()` function. The Cobra command variable is `initCmd`.
  </action>
  <verify>
    `go build ./cmd/wf/` compiles.
    Run `./wf init zsh` — outputs script containing "LBUFFER" and "wf pick".
    Run `./wf init bash` — outputs script containing "READLINE_LINE".
    Run `./wf init fish` — outputs script containing "commandline -r".
    Run `./wf init powershell` — returns error.
    `./wf init --help` shows usage.
  </verify>
  <done>`wf init zsh`, `wf init bash`, `wf init fish` each output the correct shell integration script to stdout. Invalid shell arg returns error. Command registered in root.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles
2. `./wf init zsh | grep LBUFFER` finds the zsh buffer assignment
3. `./wf init bash | grep READLINE_LINE` finds the bash buffer assignment
4. `./wf init fish | grep "commandline -r"` finds the fish buffer assignment
5. All scripts contain the fd swap pattern `3>&1 1>&2 2>&3`
6. All scripts bind Ctrl+G
</verification>

<success_criteria>
- `wf init zsh/bash/fish` outputs correct shell scripts to stdout
- Scripts use fd swap (3>&1 1>&2 2>&3) for TUI/output separation
- Scripts assign output to correct shell buffer variable
- Scripts bind Ctrl+G in both emacs and vi modes where applicable
- Invalid shell arg returns clear error message
</success_criteria>

<output>
After completion, create `.planning/phases/02-quick-picker-shell-integration/02-03-SUMMARY.md`
</output>
