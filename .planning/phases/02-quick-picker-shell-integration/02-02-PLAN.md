---
phase: 02-quick-picker-shell-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/picker/model.go
  - internal/picker/paramfill.go
  - internal/picker/styles.go
autonomous: true

must_haves:
  truths:
    - "Picker displays a search input with fuzzy-filtered workflow results below"
    - "Highlighted workflow shows full command in a preview pane"
    - "User can navigate results with arrow keys and select with Enter"
    - "Selecting a workflow with parameters transitions to parameter fill state"
    - "Selecting a zero-parameter workflow outputs the command and quits"
    - "Parameter fill shows the full command with tab-navigable input fields"
    - "Completing parameters outputs the rendered command and quits"
    - "Escape quits without output at any state"
  artifacts:
    - path: "internal/picker/model.go"
      provides: "Main Bubble Tea Model with StateSearch and StateParamFill"
      exports: ["Model", "New", "Result field"]
      min_lines: 120
    - path: "internal/picker/paramfill.go"
      provides: "Parameter fill sub-model with tab navigation and live render"
      min_lines: 40
    - path: "internal/picker/styles.go"
      provides: "Lip Gloss styles for results, preview, tags, highlights"
      min_lines: 20
  key_links:
    - from: "internal/picker/model.go"
      to: "internal/picker/search.go"
      via: "Model.Update calls Search on query change"
      pattern: "Search\\("
    - from: "internal/picker/model.go"
      to: "internal/template/parser.go"
      via: "ExtractParams called when entering StateParamFill"
      pattern: "template\\.ExtractParams"
    - from: "internal/picker/paramfill.go"
      to: "internal/template/renderer.go"
      via: "Render called for live command preview during param fill"
      pattern: "template\\.Render"
    - from: "internal/picker/model.go"
      to: "charmbracelet/bubbletea"
      via: "Implements tea.Model interface"
      pattern: "tea\\.Model"
---

<objective>
Build the Bubble Tea picker TUI model with two states: search/browse and parameter fill.

Purpose: This is the core interactive component — the fuzzy picker overlay that users see when they invoke `wf pick`. It wires the search layer (Plan 01) to a visual TUI with result list, preview pane, and inline parameter editing.
Output: `internal/picker/model.go`, `internal/picker/paramfill.go`, `internal/picker/styles.go`
</objective>

<execution_context>
@~/.config/opencode/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quick-picker-shell-integration/02-RESEARCH.md
@.planning/phases/02-quick-picker-shell-integration/02-01-SUMMARY.md
@internal/picker/search.go
@internal/store/workflow.go
@internal/template/parser.go
@internal/template/renderer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Picker model with StateSearch</name>
  <files>internal/picker/model.go, internal/picker/styles.go</files>
  <action>
    Create `internal/picker/styles.go`:
    - Define Lip Gloss styles: normalStyle, selectedStyle, highlightStyle (for fuzzy match chars), tagStyle, dimStyle, previewBorderStyle, searchPromptStyle, paramLabelStyle, paramActiveStyle.
    - Use color scheme: subtle greens/cyans for highlights against dark terminal background. Avoid purple-gradient cliches.

    Create `internal/picker/model.go`:
    - package picker
    - Define viewState enum: StateSearch, StateParamFill
    - Define Model struct with fields from RESEARCH.md Pattern 3:
      - state viewState
      - workflows []store.Workflow (all loaded, immutable after init)
      - searchInput textinput.Model (the query input)
      - results []SearchResult (a thin wrapper around fuzzy.Match that also carries the original Workflow reference — needed for rendering and preview)
      - cursor int (selected index)
      - preview viewport.Model (command preview for highlighted item)
      - selected *store.Workflow (chosen workflow, set on Enter)
      - params []template.Param (extracted params of selected workflow)
      - paramInputs []textinput.Model (one per param)
      - focusedParam int (tab index in param fill)
      - Result string (exported — the final output command, read by caller)
      - width, height int
      - maxVisible int (max results to show, derived from height)

    - Define SearchResult struct: { Workflow store.Workflow, Match fuzzy.Match }

    - New(workflows []store.Workflow) Model — constructor:
      - Initialize searchInput with placeholder "Search workflows... (@tag to filter)"
      - searchInput.Focus()
      - Call performSearch("") to populate initial results (all workflows)
      - Initialize preview viewport

    - Init() tea.Cmd — return tea.WindowSizeMsg (Bubble Tea sends this automatically, no explicit command needed; return nil)

    - Update(msg tea.Msg) (tea.Model, tea.Cmd):
      - tea.WindowSizeMsg: update width, height, maxVisible (height - 6 for search bar, preview, chrome), preview dimensions
      - tea.KeyMsg: delegate to updateSearch or updateParamFill based on state

    - updateSearch(msg tea.KeyMsg) (tea.Model, tea.Cmd):
      - "esc", "ctrl+c": set Result="" and return tea.Quit
      - "up", "ctrl+p": move cursor up (clamp to 0)
      - "down", "ctrl+n": move cursor down (clamp to len(results)-1)
      - "enter": if no results, do nothing. If selected workflow has params (template.ExtractParams), transition to StateParamFill. If no params, set Result to workflow command, return tea.Quit.
      - default: update searchInput, call performSearch with new query value, reset cursor to 0, update preview

    - performSearch(raw string) — calls ParseQuery, then Search, wraps into []SearchResult, updates preview for cursor=0

    - updatePreview() — if results exist, set preview content to results[cursor].Workflow.Command

    - View() string — delegate to viewSearch or viewParamFill based on state

    - viewSearch() string:
      - Top: search input rendered
      - Middle: result list (each line: name with highlighted match chars, description snippet truncated, tags in brackets). Show up to maxVisible results. Indicate selected row with cursor marker (">") or inverse style.
      - Bottom: preview pane with border showing command of highlighted workflow. Use viewport for scrollable preview.
      - Use lipgloss.JoinVertical to compose sections.

    - renderResultRow(sr SearchResult, isSelected bool) string:
      - Highlight matched characters using sr.Match.MatchedIndexes and highlightStyle
      - Show: name (with highlights), truncated description (dimStyle), tags (tagStyle in brackets)
      - Selected row uses selectedStyle background/bold

    Key design decisions (from CONTEXT.md):
    - Single line per result, compact fzf-style density
    - Preview pane BELOW the result list (not side panel)
    - No command text in the result line — only name, desc snippet, tags
  </action>
  <verify>
    `go build ./internal/picker/` compiles without errors.
    `go vet ./internal/picker/` passes.
  </verify>
  <done>Model implements tea.Model. StateSearch renders search input + result list + preview pane. Arrow keys navigate, Enter selects. Escape quits. Zero-param workflows output directly on Enter.</done>
</task>

<task type="auto">
  <name>Task 2: Parameter fill state with tab navigation</name>
  <files>internal/picker/model.go, internal/picker/paramfill.go</files>
  <action>
    Create `internal/picker/paramfill.go`:
    - initParamFill(m *Model) — called when transitioning from StateSearch:
      - Extract params via template.ExtractParams(m.selected.Command)
      - Create textinput.Model for each param (placeholder=param.Name, pre-fill with param.Default if non-empty)
      - Focus first input, blur rest
      - Set m.focusedParam = 0
      - Compute initial live render

    - liveRender(m *Model) string — build values map from current input values, call template.Render(m.selected.Command, values). For unfilled params with no default, leave placeholder visible.

    Update `internal/picker/model.go`:
    - updateParamFill(msg tea.KeyMsg) (tea.Model, tea.Cmd):
      - "esc": return to StateSearch (clear param state) OR quit entirely. Decision: Esc quits the whole picker (consistent with search state). User can re-invoke.
      - "tab": blur current input, advance focusedParam (wrap around), focus new input
      - "shift+tab": blur, retreat focusedParam (wrap), focus
      - "enter": if on last param or all params filled, build final values map, call template.Render to get completed command, set Result, return tea.Quit. If not on last param, advance to next param (same as tab).
      - default: update only m.paramInputs[m.focusedParam] with the message. After update, recalculate liveRender.

    - viewParamFill() string:
      - Top: header showing workflow name (selectedStyle)
      - Middle: the live-rendered command with current values. Unfilled params shown as highlighted placeholders. Use lipgloss to style the rendered command — highlight the currently-focused parameter's value differently.
      - Bottom: parameter input fields listed vertically. Each shows "param_name: [input]". Active input is highlighted. Show param description if available.
      - Footer: hint text "Tab: next  Shift+Tab: prev  Enter: paste to shell  Esc: cancel"

    From CONTEXT.md decisions:
    - Parameters with defaults are pre-filled
    - No confirmation step — completing last param + Enter pastes directly
    - Inline editing within the rendered command (show full command with params highlighted)
  </action>
  <verify>
    `go build ./internal/picker/` compiles.
    `go vet ./internal/picker/` passes.
  </verify>
  <done>StateParamFill renders live command with tab-navigable inputs. Defaults pre-filled. Enter on last param sets Result and quits. Esc cancels. Live render updates on every keystroke.</done>
</task>

</tasks>

<verification>
1. `go build ./internal/picker/` compiles without errors
2. `go vet ./internal/picker/` passes
3. `go build ./...` — full project compiles
4. Model struct has Result field readable by caller
5. Two states (StateSearch, StateParamFill) with correct transitions
</verification>

<success_criteria>
- Picker model implements tea.Model with Init/Update/View
- StateSearch: search input, result list with fuzzy highlights, preview pane, arrow key navigation
- StateParamFill: tab-navigable inputs, default pre-fill, live command render
- Zero-param workflows skip param fill (instant output)
- Escape quits cleanly at any state (Result = "")
- Compiles cleanly with go vet
</success_criteria>

<output>
After completion, create `.planning/phases/02-quick-picker-shell-integration/02-02-SUMMARY.md`
</output>
